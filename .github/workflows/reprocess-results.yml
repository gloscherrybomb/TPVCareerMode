name: Reprocess Results

# Manual trigger only - run when you need to reprocess or reset
on:
  workflow_dispatch:
    inputs:
      season:
        description: 'Season number'
        required: false
        default: '1'
        type: string
      dry_run:
        description: 'Dry run (preview changes without applying)'
        required: false
        default: false
        type: boolean
      reset_only:
        description: 'Only reset data, do not reprocess CSVs'
        required: false
        default: false
        type: boolean
      user:
        description: 'Specific user UID to reprocess (leave empty for all)'
        required: false
        type: string

jobs:
  reprocess:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install firebase-admin papaparse
      
      - name: Reprocess Results
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "ðŸ”„ Starting reprocessing..."
          
          # Build command with options
          CMD="node reprocess-results.js"
          
          if [ -n "${{ inputs.season }}" ]; then
            CMD="$CMD --season ${{ inputs.season }}"
          fi
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi
          
          if [ "${{ inputs.reset_only }}" == "true" ]; then
            CMD="$CMD --reset-only"
          fi
          
          if [ -n "${{ inputs.user }}" ]; then
            CMD="$CMD --user ${{ inputs.user }}"
          fi
          
          echo "Running: $CMD"
          eval $CMD
      
      - name: Summary
        if: always()
        run: |
          echo "### Reprocessing Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Options:**" >> $GITHUB_STEP_SUMMARY
          echo "- Season: ${{ inputs.season }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dry Run: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- Reset Only: ${{ inputs.reset_only }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.user }}" ]; then
            echo "- User: ${{ inputs.user }}" >> $GITHUB_STEP_SUMMARY
          fi
