<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - TPV Career Mode</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="tpv-team-car.png">
    <link rel="apple-touch-icon" href="tpv-team-car.png">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="events.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-text">TPV</span>
                <span class="logo-subtitle">Career Mode</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="events.html" class="nav-link active">Season</a>
                <a href="standings.html" class="nav-link">Standings</a>
                <a href="peloton.html" class="nav-link">Peloton</a>
                <a href="profile.html" class="nav-link">Profile</a>
                <a href="#" class="nav-link nav-login" id="loginBtn">Login</a>
                <a href="#" class="nav-link nav-logout" id="logoutBtn" style="display: none;">Logout</a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <div class="page-header">
        <div class="container">
            <div class="header-content">
                <div class="breadcrumb">
                    <a href="index.html">Home</a> / Events
                </div>
                <h1 class="page-title">Season Events</h1>
                <p class="page-subtitle">Complete events to earn points and climb the rankings</p>
            </div>
        </div>
    </div>

    <!-- Season Selector -->
    <section class="season-selector-section">
        <div class="container">
            <div class="season-selector-wrapper">
                <label for="seasonSelect" class="season-selector-label">
                    <span class="season-icon">üèÜ</span>
                    <span>Season:</span>
                </label>
                <div class="season-select-container">
                    <select id="seasonSelect" class="season-select" onchange="selectSeason(this.value)">
                        <option value="1" selected>Season 1 - Local Amateur</option>
                        <option value="2" disabled>Season 2 - Continental Pro (Coming Soon)</option>
                        <option value="3" disabled>Season 3 - Pro Continental (Coming Soon)</option>
                        <option value="4" disabled>Season 4 - World Tour (Coming Soon)</option>
                        <option value="5" disabled>Season 5 - Legends (Coming Soon)</option>
                    </select>
                    <div class="select-arrow">
                        <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                            <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="progress-overview">
        <div class="container">
            <!-- Season Timeline -->
            <div class="season-timeline">
                <div class="timeline-header">
                    <h3>Season 1 Progress</h3>
                    <div class="timeline-controls">
                        <button class="admin-toggle" id="adminToggle" style="display: none;">
                            <span id="adminStatus">Admin Mode: OFF</span>
                        </button>
                    </div>
                </div>
                
                <div class="timeline-track">
                    <div class="timeline-line"></div>
                    <div class="timeline-stages" id="timelineStages">
                        <!-- Timeline stages will be generated by JavaScript -->
                    </div>
                    <div class="cyclist-marker" id="cyclistMarker">
                        <img src="tpv-team-car.png" alt="Team Car" class="cyclist-icon">
                    </div>
                </div>
                <div class="timeline-legend">
                    <div class="legend-item">
                        <span class="legend-dot completed"></span>
                        <span>Completed</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot unlocked"></span>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot locked"></span>
                        <span>Locked</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot choice"></span>
                        <span>Choice Stage</span>
                    </div>
                </div>
            </div>

            <!-- Progress Stats -->
            <div class="progress-grid">
                <div class="progress-card">
                    <div class="progress-icon">üéØ</div>
                    <div class="progress-info">
                        <div class="progress-label">Current Stage</div>
                        <div class="progress-value" id="currentStageText">Stage 1</div>
                    </div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">‚úì</div>
                    <div class="progress-info">
                        <div class="progress-label">Stages Completed</div>
                        <div class="progress-value" id="completedStagesText">0 / 9</div>
                    </div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">‚≠ê</div>
                    <div class="progress-info">
                        <div class="progress-label">Points Earned</div>
                        <div class="progress-value" id="pointsEarnedText">0</div>
                    </div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">üèÜ</div>
                    <div class="progress-info">
                        <div class="progress-label">Season Rank</div>
                        <div class="progress-value" id="seasonRankText">-</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="events-section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title-small">Season 1: Local Amateur</h2>
            </div>

            <!-- Season Story/Report -->
            <div class="season-story-box" id="seasonStoryBox">
                <div class="season-story-content" id="seasonStoryContent">
                    <p>This is the true beginning of your career - the moment where you stop imagining what it would feel like to "be a rider" and actually step into it. The races may be small, the crowds may be local, but every start line feels electric because you are finally part of it. This is your chance to experience that classic pro cycling manager journey, only now it is you doing the riding, you making the decisions, and you earning every result with your own legs. At this level, every race is an opportunity: the crits sharpen your instincts, the climbs test your composure, and the time trials reveal what you are really capable of when it is just you against the clock. Nothing is handed to you, but that is the appeal - each place you gain, each expectation you beat, feels like your first steps toward something bigger. You are not chasing fame yet; you are chasing proof that you belong here. It is the start of a long road, but a meaningful one. And if you can master these early races - these local, gritty, character-building tests - you will lay the foundation for everything that comes next. This is not just a season. It is the pro cyclist origin story you have always imagined, and you are finally writing the first chapter.</p>
                </div>
            </div>

            <div class="events-sequence" id="eventsSequence">
                <!-- Event stages will be generated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Choice Selection Modal -->
    <div class="modal" id="choiceModal">
        <div class="modal-overlay" id="choiceModalOverlay"></div>
        <div class="modal-content choice-modal-content">
            <button class="modal-close" id="choiceModalClose">&times;</button>
            <h2 class="modal-title">Select Your Event</h2>
            <p class="choice-subtitle">Choose one optional event to complete for this stage. Each event can only be completed once.</p>
            <div class="choice-events-grid" id="choiceEventsGrid">
                <!-- Available events will be populated here -->
            </div>
        </div>
    </div>
    <div class="login-prompt">
        <div class="container">
            <div class="prompt-content">
                <h3>Track Your Progress</h3>
                <p>Login to save your results, earn points, and compete on the leaderboards.</p>
                <button class="btn btn-primary" id="promptLoginBtn">Login / Sign Up</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">TPV Career Mode</div>
                    <p>Virtual cycling career progression</p>
                </div>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Events</a>
                    <a href="peloton.html">Meet the Peloton</a>
                    <a href="standings.html">Standings</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 TPV Career Mode. TPV Career Mode is a community effort completely independent from TrainingPeaks and TrainingPeaks Virtual.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal (reused from index.html) -->
    <div class="modal" id="loginModal">
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <h2 class="modal-title">Welcome Back</h2>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="login">Login</button>
                <button class="modal-tab" data-tab="signup">Sign Up</button>
            </div>
            
            <div class="tab-content active" id="loginTab">
                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="form-group-checkbox">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe" checked>
                            <span class="checkbox-text">Remember me</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Login</button>
                </form>
                <div class="auth-divider">
                    <span>or</span>
                </div>
                <button class="btn btn-google" id="googleLoginBtn">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                        <path fill="none" d="M0 0h48v48H0z"/>
                    </svg>
                    Continue with Google
                </button>
            </div>

            <div class="tab-content" id="signupTab">
                <form class="auth-form" id="signupForm">
                    <div class="form-group">
                        <label for="signupName">Rider Name</label>
                        <input type="text" id="signupName" required>
                    </div>
                    <div class="form-group">
                        <label for="signupUID">
                            TrainingPeaks Virtual UID
                            <span class="field-hint">Find this in your TPV profile or past race results</span>
                        </label>
                        <input 
                            type="text" 
                            id="signupUID" 
                            placeholder="e.g., 212354980F57BA1B" 
                            pattern="[0-9A-Fa-f]{16}"
                            maxlength="16"
                            required
                            style="text-transform: uppercase; font-family: 'Courier New', monospace;">
                        <small class="field-help">16-character code that links your TPV results to your career</small>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required>
                    </div>
                </form>
                <div class="auth-divider">
                    <span>or</span>
                </div>
                <button class="btn btn-google" id="googleSignupBtn">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                        <path fill="none" d="M0 0h48v48H0z"/>
                    </svg>
                    Sign Up with Google
                </button>
            </div>
        </div>
    </div>

    <!-- UID Modal for Google Sign-In Users -->
    <div class="modal" id="uidModal">
        <div class="modal-overlay" id="uidModalOverlay"></div>
        <div class="modal-content">
            <h2 class="modal-title">Complete Your Profile</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                To link your TrainingPeaks Virtual results, please enter your TPV UID.
            </p>
            <form class="auth-form" id="uidForm">
                <div class="form-group">
                    <label for="googleUID">
                        TrainingPeaks Virtual UID
                        <span class="field-hint">Find this in your TPV profile or past race results</span>
                    </label>
                    <input 
                        type="text" 
                        id="googleUID" 
                        placeholder="e.g., 212354980F57BA1B" 
                        pattern="[0-9A-Fa-f]{16}"
                        maxlength="16"
                        required
                        style="text-transform: uppercase; font-family: 'Courier New', monospace;">
                    <small class="field-help">16-character code that links your TPV results to your career</small>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Save UID</button>
            </form>
        </div>
    </div>

    <script src="event-data.js"></script>
    <script type="module" src="event-sequence.js"></script>
    <script type="module" src="app.js"></script>
    <script src="events.js"></script>
    <script>
        // Render the timeline
        function renderTimeline() {
            console.log('=== renderTimeline START ===');
            const timelineStages = document.getElementById('timelineStages');
            const cyclistMarker = document.getElementById('cyclistMarker');
            
            console.log('Elements found:', { timelineStages, cyclistMarker });
            
            // Use window objects explicitly
            const eventSequence = window.eventSequence;
            const progressManager = window.progressManager;
            const getStageStatus = window.getStageStatus;
            
            console.log('Objects loaded:', { 
                eventSequence: !!eventSequence, 
                progressManager: !!progressManager, 
                getStageStatus: !!getStageStatus 
            });
            
            if (!eventSequence || !progressManager || !getStageStatus) {
                console.error('Required objects not loaded yet');
                return;
            }
            
            console.log('Mapping eventSequence with', eventSequence.length, 'stages');
            
            try {
                timelineStages.innerHTML = eventSequence.map((stage, index) => {
                    const status = getStageStatus(stage.stage);
                    const isChoice = stage.type === 'choice';
                    
                    console.log(`Stage ${stage.stage}: status=${status}, isChoice=${isChoice}`);
                    
                    return `
                        <div class="timeline-stage ${status} ${isChoice ? 'choice-stage' : ''}" data-stage="${stage.stage}">
                            <div class="stage-dot"></div>
                            <div class="stage-label">
                                <div class="stage-number">Stage ${stage.stage}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('Timeline HTML generated, length:', timelineStages.innerHTML.length);
            } catch (error) {
                console.error('Error generating timeline HTML:', error);
                return;
            }

            // Position team car marker
            const currentStage = progressManager.getCurrentStage();
            console.log('Rendering timeline with currentStage:', currentStage);
            const stageElements = timelineStages.querySelectorAll('.timeline-stage');
            if (stageElements.length > 0) {
                const currentIndex = Math.min(currentStage - 1, stageElements.length - 1);
                const stageElement = stageElements[currentIndex];
                if (stageElement) {
                    const position = (currentIndex / (stageElements.length - 1)) * 100;
                    cyclistMarker.style.left = `${position}%`;
                    console.log(`Team car positioned at stage ${currentStage} (${position}%)`);
                }
            }
            
            console.log('=== renderTimeline COMPLETE ===');
        }

        // Render event sequence
        function renderEventSequence() {
            console.log('=== renderEventSequence START ===');
            const eventsSequence = document.getElementById('eventsSequence');
            
            console.log('eventsSequence element found:', !!eventsSequence);
            
            // Use window objects explicitly
            const eventSequence = window.eventSequence;
            const progressManager = window.progressManager;
            const getStageStatus = window.getStageStatus;
            const getEvent = window.getEvent;
            
            console.log('Objects loaded:', {
                eventSequence: !!eventSequence,
                progressManager: !!progressManager,
                getStageStatus: !!getStageStatus,
                getEvent: !!getEvent
            });
            
            if (!eventSequence || !progressManager || !getStageStatus || !getEvent) {
                console.error('Required objects not loaded yet for renderEventSequence');
                return;
            }
            
            console.log('Mapping eventSequence with', eventSequence.length, 'stages');
            
            try {
                eventsSequence.innerHTML = eventSequence.map((stage, index) => {
                    const status = getStageStatus(stage.stage);
                    const isChoice = stage.type === 'choice';
                    const isLocked = status === 'locked';
                    const isCompleted = status === 'completed';
                    
                    console.log(`Rendering stage ${stage.stage}: status=${status}, isChoice=${isChoice}`);
                    
                    if (isChoice) {
                        // Choice stage
                        const selectedEventId = progressManager.getChoiceSelection(stage.stage);
                        const availableCount = progressManager.getAvailableOptionalEvents(stage.stage).length;
                    
                    return `
                        <div class="sequence-stage ${status}" data-stage="${stage.stage}">
                            <div class="stage-connector"></div>
                            <div class="stage-card choice-card">
                                <div class="stage-card-header">
                                    <span class="stage-number-badge">Stage ${stage.stage}</span>
                                    <span class="stage-type-badge choice">Optional Choice</span>
                                </div>
                                <div class="stage-card-content">
                                    <div class="stage-icon-large">${stage.icon}</div>
                                    <h3 class="stage-title">${stage.name}</h3>
                                    <p class="stage-description">
                                        ${selectedEventId ? 
                                            `Selected: ${getEvent(selectedEventId).name}` :
                                            `${availableCount} optional events available`
                                        }
                                    </p>
                                    ${isLocked ? '<div class="locked-overlay"><span>üîí</span><p>Complete previous stage to unlock</p></div>' : ''}
                                </div>
                                <div class="stage-card-footer">
                                    ${!isLocked && !isCompleted ? `<button class="btn btn-primary btn-full" onclick="openChoiceModal(${stage.stage})">Choose Event</button>` : ''}
                                    ${isCompleted ? '<span class="completed-badge">‚úì Completed</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Mandatory stage
                    const event = getEvent(stage.eventId);
                    
                    return `
                        <div class="sequence-stage ${status}" data-stage="${stage.stage}">
                            <div class="stage-connector"></div>
                            <div class="stage-card event-card-sequential">
                                <div class="stage-card-header">
                                    <span class="stage-number-badge">Stage ${stage.stage}</span>
                                    <span class="stage-type-badge mandatory">Mandatory</span>
                                </div>
                                <div class="event-image">
                                    <div class="event-image-placeholder">
                                        <span>${event.icon}</span>
                                    </div>
                                    ${isLocked ? '<div class="locked-overlay"><span>üîí</span><p>Complete previous stage</p></div>' : ''}
                                </div>
                                <div class="stage-card-content">
                                    <h3 class="stage-title">${event.name}</h3>
                                    <p class="stage-description">${event.subtitle}</p>
                                    <div class="event-stats">
                                        <div class="stat-item">
                                            <span class="stat-icon">üìè</span>
                                            <span>${event.distance}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">‚õ∞Ô∏è</span>
                                            <span>${event.climbing}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">‚≠ê</span>
                                            <span>${event.maxPoints} pts</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="stage-card-footer">
                                    ${!isLocked ? `<button class="btn btn-secondary btn-full" onclick="location.href='event-detail.html?id=${event.number}'">View Details</button>` : ''}
                                    ${isCompleted ? '<span class="completed-badge">‚úì Completed</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            console.log('EventSequence HTML generated, length:', eventsSequence.innerHTML.length);
            console.log('=== renderEventSequence COMPLETE ===');
        } catch (error) {
            console.error('Error in renderEventSequence:', error);
        }
    }

        // Update progress stats
        async function updateProgressStats() {
            const progressManager = window.progressManager;
            const eventSequence = window.eventSequence;
            
            if (!progressManager || !eventSequence) {
                console.error('Required objects not loaded yet in updateProgressStats');
                return;
            }
            
            const current = progressManager.getCurrentStage();
            const completed = progressManager.progress.completedStages.length;
            const total = eventSequence.length;
            const points = progressManager.getTotalPoints();
            
            document.getElementById('currentStageText').textContent = `Stage ${current}`;
            document.getElementById('completedStagesText').textContent = `${completed} / ${total}`;
            document.getElementById('pointsEarnedText').textContent = points.toString();
            
            // Fetch and display season rank
            await updateSeasonRank();
            
            // Update season story/report
            await updateSeasonStory();
        }
        
        // Fetch and display user's season rank
        async function updateSeasonRank() {
            const rankText = document.getElementById('seasonRankText');
            
            // Check if user is logged in
            if (!progressManager.currentUser) {
                rankText.textContent = '-';
                return;
            }
            
            try {
                // Import Firebase functions
                const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore();
                
                // Fetch user data - same as standings page does
                const userDoc = await getDoc(doc(db, 'users', progressManager.currentUser.uid));
                const userData = userDoc.data();
                
                // Check if we have season standings data
                let standings = userData?.season1Standings;
                
                if (!standings || standings.length === 0) {
                    // No standings data yet
                    rankText.textContent = '-';
                    return;
                }
                
                // Find current user in standings (marked with isCurrentUser: true)
                const userPosition = standings.findIndex(racer => racer.isCurrentUser === true);
                
                if (userPosition === -1) {
                    rankText.textContent = '-';
                    return;
                }
                
                // Format position with ordinal suffix
                const rank = userPosition + 1;
                const suffix = getRankSuffix(rank);
                rankText.textContent = `${rank}${suffix}`;
                
            } catch (error) {
                console.error('Error fetching season rank:', error);
                rankText.textContent = '-';
            }
        }
        
        // Update season story or end-of-season report
        async function updateSeasonStory() {
            const storyContent = document.getElementById('seasonStoryContent');
            
            // Check if element exists
            if (!storyContent) {
                console.error('seasonStoryContent element not found');
                return;
            }
            
            // Check if required objects are available
            if (typeof window.eventSequence === 'undefined' || typeof window.progressManager === 'undefined') {
                console.log('Waiting for eventSequence and progressManager to load...');
                // Set a default message while loading
                storyContent.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading...</p>';
                return;
            }
            
            // Use window.eventSequence and window.progressManager to be explicit
            const eventSequence = window.eventSequence;
            const progressManager = window.progressManager;
            
            // Check if season is complete (all 9 stages completed)
            const totalStages = eventSequence.length;
            const completedStages = progressManager.progress.completedStages.length;
            const isSeasonComplete = completedStages === totalStages;
            
            console.log(`Season status: ${completedStages}/${totalStages} stages completed`);
            
            if (!isSeasonComplete) {
                // Show introduction text
                storyContent.innerHTML = '<p>This is the true beginning of your career - the moment where you stop imagining what it would feel like to "be a rider" and actually step into it. The races may be small, the crowds may be local, but every start line feels electric because you are finally part of it. This is your chance to experience that classic pro cycling manager journey, only now it is you doing the riding, you making the decisions, and you earning every result with your own legs. At this level, every race is an opportunity: the crits sharpen your instincts, the climbs test your composure, and the time trials reveal what you are really capable of when it is just you against the clock. Nothing is handed to you, but that is the appeal - each place you gain, each expectation you beat, feels like your first steps toward something bigger. You are not chasing fame yet; you are chasing proof that you belong here. It is the start of a long road, but a meaningful one. And if you can master these early races - these local, gritty, character-building tests - you will lay the foundation for everything that comes next. This is not just a season. It is the pro cyclist origin story you have always imagined, and you are finally writing the first chapter.</p>';
                storyContent.classList.remove('report');
                console.log('Season introduction text loaded');
            } else {
                // Season is complete - show appropriate end-of-season report
                await showEndOfSeasonReport(storyContent);
            }
        }
        
        // Show end-of-season report based on final ranking
        async function showEndOfSeasonReport(storyContent) {
            try {
                // Get user's final rank
                const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore();
                
                if (!progressManager.currentUser) {
                    storyContent.innerHTML = '<p>Complete the season to see your final report!</p>';
                    return;
                }
                
                // Fetch user data
                const userDoc = await getDoc(doc(db, 'users', progressManager.currentUser.uid));
                const userData = userDoc.data();
                
                // Get standings
                let standings = userData?.season1Standings;
                
                if (!standings || standings.length === 0) {
                    storyContent.innerHTML = '<p>Complete the season to see your final report!</p>';
                    return;
                }
                
                // Find user's final position
                const userPosition = standings.findIndex(racer => racer.isCurrentUser === true);
                
                if (userPosition === -1) {
                    storyContent.innerHTML = '<p>Complete the season to see your final report!</p>';
                    return;
                }
                
                const rank = userPosition + 1;
                const totalRiders = standings.length;
                const midPoint = Math.ceil(totalRiders / 2);
                
                let reportText = '';
                let reportTitle = '';
                
                if (rank === 1) {
                    reportTitle = 'Post-Season Report: 1st Place';
                    reportText = 'You could not have asked for a stronger first season. Race after race, you showed up ready, handled whatever the course threw at you, and kept placing well above what anyone expected at this level. You looked confident in the fast races, sharp in the climbs, and steady in the tougher moments, rewarded with a 1st place finish. Riders who finish a season like this do not stay in the local ranks for long. You have clearly outgrown this tier - now it is time to see what you can do against bigger fields.';
                } else if (rank <= 3) {
                    reportTitle = 'Post-Season Report: Podium Finish';
                    reportText = 'This season showed you are right on the edge of breaking through. You were in the mix almost every weekend - close to the front, picking up strong finishes, and proving you know how to handle different types of races. There is a bit of polishing left to do, but the foundation is there. You have built momentum, gained respect in the local bunch, and put yourself in a position where moving up a tier feels like a matter of when, not if. You were rightly rewarded with a podium finish.';
                } else if (rank <= midPoint) {
                    reportTitle = 'Post-Season Report: Upper Half Finish';
                    reportText = 'You ended the year in the middle of the standings, but the story is not about the ranking - it is about the steps you took. You held your own in tougher fields, figured out your strengths, and learned how to manage the chaos of real racing. There were moments where everything clicked, and others where you were simply hanging on, but that is what these early seasons are for. With a bit more experience and focus, you will be fighting for bigger results before long.';
                } else {
                    reportTitle = 'Post-Season Report: Season Complete';
                    reportText = 'It was a tough season, and the results show it - but that does not mean it was wasted. Every rider has a year like this early on, where the learning curve is steep and every race feels like a new lesson. You stuck it out, finished your events, and started to understand what this level demands. The important part is that you are still here and now have a clearer picture of where you need to improve. Take what you have learned, regroup, and come back stronger next season.';
                }
                
                storyContent.innerHTML = `
                    <div class="season-story-title">${reportTitle}</div>
                    <p>${reportText}</p>
                `;
                storyContent.classList.add('report');
                
            } catch (error) {
                console.error('Error showing end-of-season report:', error);
                storyContent.innerHTML = '<p>Complete the season to see your final report!</p>';
            }
        }
        
        // Helper function to get ordinal suffix
        function getRankSuffix(rank) {
            if (rank >= 11 && rank <= 13) return 'th';
            const lastDigit = rank % 10;
            if (lastDigit === 1) return 'st';
            if (lastDigit === 2) return 'nd';
            if (lastDigit === 3) return 'rd';
            return 'th';
        }

        // Open choice modal
        function openChoiceModal(stage) {
            const progressManager = window.progressManager;
            const getEvent = window.getEvent;
            
            if (!progressManager || !getEvent) {
                console.error('Required objects not loaded yet');
                return;
            }
            
            const modal = document.getElementById('choiceModal');
            const grid = document.getElementById('choiceEventsGrid');
            const availableEvents = progressManager.getAvailableOptionalEvents(stage);
            
            grid.innerHTML = availableEvents.map(eventId => {
                const event = getEvent(eventId);
                return `
                    <div class="choice-event-card" onclick="selectChoiceEvent(${stage}, ${eventId})">
                        <div class="choice-event-icon">${event.icon}</div>
                        <h4>${event.name}</h4>
                        <p>${event.subtitle}</p>
                        <div class="choice-event-stats">
                            <span>üìè ${event.distance}</span>
                            <span>‚õ∞Ô∏è ${event.climbing}</span>
                            <span>‚≠ê ${event.maxPoints} pts</span>
                        </div>
                        <button class="btn btn-primary btn-small">Select</button>
                    </div>
                `;
            }).join('');
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Store current choice stage
            modal.dataset.choiceStage = stage;
        }

        // Select choice event
        function selectChoiceEvent(stage, eventId) {
            closeChoiceModal();
            // Redirect to event detail page for the selected event
            location.href = `event-detail.html?id=${eventId}&stage=${stage}&choice=true`;
        }

        // Close choice modal
        function closeChoiceModal() {
            const modal = document.getElementById('choiceModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired');
            
            // Setup modal close handlers
            document.getElementById('choiceModalClose').addEventListener('click', closeChoiceModal);
            document.getElementById('choiceModalOverlay').addEventListener('click', closeChoiceModal);
            
            // Wait for event-sequence.js module to load and attach to window
            const initializeUI = () => {
                console.log('Checking for required objects...', {
                    eventSequence: typeof window.eventSequence,
                    progressManager: typeof window.progressManager,
                    getStageStatus: typeof window.getStageStatus,
                    getEvent: typeof window.getEvent
                });
                
                if (typeof window.eventSequence === 'undefined' || typeof window.progressManager === 'undefined') {
                    // Module not loaded yet, wait a bit
                    console.log('Waiting for modules to load...');
                    setTimeout(initializeUI, 50);
                    return;
                }
                
                console.log('All required objects loaded!');
                console.log('Event sequence length:', window.eventSequence.length);
                console.log('Progress Manager:', window.progressManager);
                
                try {
                    // Show admin toggle for testing (remove in production or check real auth)
                    document.getElementById('adminToggle').style.display = 'inline-block';
                    
                    // Setup admin toggle (temporary - will be replaced with real auth)
                    document.getElementById('adminToggle').addEventListener('click', () => {
                        const progressManager = window.progressManager;
                        if (!progressManager) return;
                        
                        progressManager.setAdminMode(!progressManager.isAdmin);
                        document.getElementById('adminStatus').textContent = 
                            progressManager.isAdmin ? 'Admin Mode: ON' : 'Admin Mode: OFF';
                        renderEventSequence();
                        renderTimeline();
                    });
                    
                    console.log('Calling renderTimeline...');
                    renderTimeline();
                    
                    console.log('Calling renderEventSequence...');
                    renderEventSequence();
                    
                    console.log('Calling updateProgressStats...');
                    updateProgressStats();
                    
                    console.log('UI initialization complete!');
                } catch (error) {
                    console.error('Error during UI initialization:', error);
                }
            };
            
            initializeUI();
        });

        // Global function to update UI when progress changes (called by Firebase)
        window.updateProgressUI = function() {
            console.log('Updating UI after Firebase progress load');
            renderTimeline();
            renderEventSequence();
            updateProgressStats();
        };

        // Make functions global for onclick handlers
        window.openChoiceModal = openChoiceModal;
        window.selectChoiceEvent = selectChoiceEvent;
        
        // Season selection handler
        window.selectSeason = function(seasonNumber) {
            // Convert to number if it's a string
            seasonNumber = parseInt(seasonNumber);
            
            // Currently only Season 1 is available
            if (seasonNumber !== 1) {
                // Future seasons are locked - revert to Season 1
                document.getElementById('seasonSelect').value = '1';
                return;
            }
            
            // Season 1 is already active, no action needed
            // In the future, this will load different season data
            console.log(`Season ${seasonNumber} selected`);
        };
    </script>
</body>
</html>
