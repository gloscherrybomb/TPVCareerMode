<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - TPV Career Mode</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="tpv-team-car.png">
    <link rel="apple-touch-icon" href="tpv-team-car.png">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="events.css">
    <link rel="stylesheet" href="season-completion.css">
    <link rel="stylesheet" href="achievement-notifications.css">
    <link rel="stylesheet" href="cadence-credits.css">
    <link rel="stylesheet" href="season-switcher.css">
    <link rel="stylesheet" href="icons/icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-text">TPV</span>
                <span class="logo-subtitle">Career Mode</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="events.html" class="nav-link active">Season</a>
                <a href="standings.html" class="nav-link">Standings</a>
                <a href="peloton.html" class="nav-link">Peloton</a>
                <a href="profile.html" class="nav-link">Profile</a>
                <a href="special-events.html" class="nav-link">Special Events</a>
                <a href="#" class="nav-link nav-login" id="loginBtn">Login</a>
                <a href="#" class="nav-link nav-logout" id="logoutBtn" style="display: none;">Logout</a>
                <a href="#" class="nav-link nav-support" id="supportBtn" style="display: none;" title="Support TPV Career Mode"><img src="icons/svg/awards/glowing-star.svg" alt="Support" class="nav-support-icon"></a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <div class="page-header">
        <div class="container">
            <div class="header-content">
                <div class="breadcrumb">
                    <a href="index.html">Home</a> / Events
                </div>
                <h1 class="page-title">Season Events</h1>
                <p class="page-subtitle">Complete events to earn points and climb the rankings</p>
            </div>
        </div>
    </div>

    <!-- Season Selector -->
    <section class="season-selector-section">
        <div class="container">
            <!-- Season switcher will be rendered here by JavaScript -->
            <div id="seasonSwitcherContainer" class="season-selector-wrapper"></div>
            <!-- History banner shown when viewing a completed past season -->
            <div id="seasonHistoryBanner" style="display: none;"></div>
        </div>
    </section>

    <section class="progress-overview">
        <div class="container">
            <!-- Season Timeline -->
            <div class="season-timeline">
                <div class="timeline-header">
                    <h3>Season 1 Progress</h3>
                    <div class="timeline-controls">
                        <button class="admin-toggle" id="adminToggle" style="display: none;">
                            <span id="adminStatus">Admin Mode: OFF</span>
                        </button>
                    </div>
                </div>
                
                <div class="timeline-track">
                    <div class="timeline-line"></div>
                    <div class="timeline-stages" id="timelineStages">
                        <!-- Timeline stages will be generated by JavaScript -->
                    </div>
                    <div class="cyclist-marker" id="cyclistMarker" title="Click to go to next event">
                        <img src="tpv-team-car.png" alt="Team Car" class="cyclist-icon">
                    </div>
                </div>
                <div class="timeline-legend">
                    <div class="legend-item">
                        <span class="legend-dot completed"></span>
                        <span>Completed</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot unlocked"></span>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot locked"></span>
                        <span>Locked</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot choice"></span>
                        <span>Choice Stage</span>
                    </div>
                </div>
            </div>

            <!-- Progress Stats -->
            <div class="progress-grid">
                <div class="progress-card">
                    <div class="progress-icon" id="progressIconStage"></div>
                    <div class="progress-info">
                        <div class="progress-label">Current Stage</div>
                        <div class="progress-value" id="currentStageText">Stage 1</div>
                    </div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon" id="progressIconCompleted"></div>
                    <div class="progress-info">
                        <div class="progress-label">Stages Completed</div>
                        <div class="progress-value" id="completedStagesText">0 / 9</div>
                    </div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon" id="progressIconPoints"></div>
                    <div class="progress-info">
                        <div class="progress-label">Points Earned</div>
                        <div class="progress-value" id="pointsEarnedText">0</div>
                    </div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon" id="progressIconRank"></div>
                    <div class="progress-info">
                        <div class="progress-label">Season Rank</div>
                        <div class="progress-value" id="seasonRankText">-</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="events-section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title-small">Season 1: Local Amateur</h2>
            </div>

            <!-- Season Story/Report -->
            <div class="season-story-box" id="seasonStoryBox">
                <div class="season-story-content" id="seasonStoryContent">
                    <p>This is the true beginning of your career - the moment where you stop imagining what it would feel like to "be a rider" and actually step into it. The races may be small, the crowds may be local, but every start line feels electric because you are finally part of it. This is your chance to experience that classic pro cycling manager journey, only now it is you doing the riding, you making the decisions, and you earning every result with your own legs. At this level, every race is an opportunity: the crits sharpen your instincts, the climbs test your composure, and the time trials reveal what you are really capable of when it is just you against the clock. Nothing is handed to you, but that is the appeal - each place you gain, each expectation you beat, feels like your first steps toward something bigger. You are not chasing fame yet; you are chasing proof that you belong here. It is the start of a long road, but a meaningful one. And if you can master these early races - these local, gritty, character-building tests - you will lay the foundation for everything that comes next. This is not just a season. It is the pro cyclist origin story you have always imagined, and you are finally writing the first chapter.</p>
                </div>
            </div>

            <div class="events-sequence" id="eventsSequence">
                <!-- Event stages will be generated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Choice Selection Modal -->
    <div class="modal" id="choiceModal">
        <div class="modal-overlay" id="choiceModalOverlay"></div>
        <div class="modal-content choice-modal-content">
            <button class="modal-close" id="choiceModalClose">&times;</button>
            <h2 class="modal-title">Select Your Event</h2>
            <p class="choice-subtitle">Choose one Rider's Choice event to complete for this stage. Each event can only be completed once.</p>
            <div class="choice-events-grid" id="choiceEventsGrid">
                <!-- Available events will be populated here -->
            </div>
        </div>
    </div>
    <div class="login-prompt">
        <div class="container">
            <div class="prompt-content">
                <h3>Track Your Progress</h3>
                <p>Login to save your results, earn points, and compete on the leaderboards.</p>
                <button class="btn btn-primary" id="promptLoginBtn">Login / Sign Up</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">TPV Career Mode</div>
                    <p>Virtual cycling career progression</p>
                    <a href="https://discord.com/channels/1055575215884750978/1443564120719888384" class="footer-discord" target="_blank" rel="noopener" title="Join the Discussion on Discord">
                        <img src="assets/Discord-Symbol-Blurple.png" alt="Discord" width="20" height="20">
                        Discussion
                    </a>
                </div>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Season</a>
                    <a href="standings.html">Standings</a>
                    <a href="peloton.html">Peloton</a>
                    <a href="special-events.html">Special Events</a>
                    <a href="beginners-guide.html">Beginner's Guide</a>
                    <a href="about.html">About</a>
                    <a href="privacy.html">Privacy</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 TPV Career Mode. TPV Career Mode is a community effort completely independent from TrainingPeaks and TrainingPeaks Virtual.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal (reused from index.html) -->
    <div class="modal" id="loginModal">
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <h2 class="modal-title">Welcome Back</h2>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="login">Login</button>
                <button class="modal-tab" data-tab="signup">Sign Up</button>
            </div>
            
            <div class="tab-content active" id="loginTab">
                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="form-group-checkbox">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe" checked>
                            <span class="checkbox-text">Remember me</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Login</button>
                </form>
                <div class="auth-divider">
                    <span>or</span>
                </div>
                <button class="btn btn-google" id="googleLoginBtn">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 .46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8. 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                        <path fill="none" d="M0 0h48v48H0z"/>
                    </svg>
                    Continue with Google
                </button>
            </div>

            <div class="tab-content" id="signupTab">
                <form class="auth-form" id="signupForm">
                    <div class="form-group">
                        <label for="signupName">Rider Name</label>
                        <input type="text" id="signupName" required>
                    </div>
                    <div class="form-group">
                        <label for="signupUID">
                            TrainingPeaks Virtual UID
                            <span class="field-hint">Find this in your TPV profile or past race results</span>
                        </label>
                        <input 
                            type="text" 
                            id="signupUID" 
                            placeholder="e.g., 212354980F57BA1B" 
                            pattern="[0-9A-Fa-f]{15,16}"
                            maxlength="16"
                            required
                            style="text-transform: uppercase; font-family: 'Courier New', monospace;">
                        <small class="field-help">16-character code that links your TPV results to your career</small>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required>
                    </div>
                </form>
                <div class="auth-divider">
                    <span>or</span>
                </div>
                <button class="btn btn-google" id="googleSignupBtn">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                        <path fill="none" d="M0 0h48v48H0z"/>
                    </svg>
                    Sign Up with Google
                </button>
            </div>
        </div>
    </div>

    <!-- UID Modal for Google Sign-In Users -->
    <div class="modal" id="uidModal">
        <div class="modal-overlay" id="uidModalOverlay"></div>
        <div class="modal-content">
            <h2 class="modal-title">Complete Your Profile</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                To link your TrainingPeaks Virtual results, please enter your TPV UID.
            </p>
            <form class="auth-form" id="uidForm">
                <div class="form-group">
                    <label for="googleUID">
                        TrainingPeaks Virtual UID
                        <span class="field-hint">Find this in your TPV profile or past race results</span>
                    </label>
                    <input 
                        type="text" 
                        id="googleUID" 
                        placeholder="e.g., 212354980F57BA1B" 
                        pattern="[0-9A-Fa-f]{15,16}"
                        maxlength="16"
                        required
                        style="text-transform: uppercase; font-family: 'Courier New', monospace;">
                    <small class="field-help">16-character code that links your TPV results to your career</small>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Save UID</button>
            </form>
        </div>
    </div>

    <!-- Support/Donate Modal -->
    <div class="modal" id="supportModal">
        <div class="modal-overlay" id="supportModalOverlay"></div>
        <div class="modal-content support-modal-content">
            <button class="modal-close" id="supportModalClose">&times;</button>
            <div class="support-modal-header">
                <span class="support-modal-icon"><img src="icons/svg/awards/glowing-star.svg" alt="Support"></span>
                <h2 class="modal-title">Support TPV Career Mode</h2>
            </div>
            <div class="support-modal-body">
                <p class="support-description">
                    TPV Career Mode is a passion project built by the community, for the community. Your support helps cover hosting costs and enables new features.
                </p>
                <div class="support-rewards">
                    <h3>Contributor Rewards (&#163;5+)</h3>
                    <ul class="rewards-list">
                        <li><span class="reward-icon"><img src="icons/svg/awards/glowing-star.svg" alt="Star"></span> Permanent star badge next to your name in rankings</li>
                        <li><span class="reward-icon"><img src="icons/svg/awards/sparkles.svg" alt="Sparkles"></span> Exclusive glowing profile effects</li>
                        <li><span class="reward-icon"><img src="icons/svg/ui/book.svg" alt="Book"></span> Access to contributor-only story content</li>
                    </ul>
                </div>
                <p class="support-note">
                    After donating on Ko-fi, your contributor status will be activated within 24 hours.
                    Your TPV account ID is automatically included in the donation.
                </p>
                <a href="#" class="btn btn-primary btn-kofi" id="kofiBtn" target="_blank" rel="noopener">
                    <img src="icons/svg/ui/coffee.svg" alt="Coffee" class="kofi-icon"> Support on Ko-fi
                </a>
            </div>
        </div>
    </div>

    <script src="icons/icons.js"></script>
    <script src="event-data.js"></script>
    <script src="season-config.js"></script>
    <script src="season-data-helpers.js"></script>
    <script src="season-switcher.js"></script>
    <script type="module" src="event-sequence.js"></script>
    <script type="module" src="app.js"></script>
    <script src="events.js"></script>
    <script>
        // Render the timeline
        function renderTimeline() {
            console.log('=== renderTimeline START ===');
            const timelineStages = document.getElementById('timelineStages');
            const cyclistMarker = document.getElementById('cyclistMarker');
            
            console.log('Elements found:', { timelineStages, cyclistMarker });
            
            // Use window objects explicitly
            const eventSequence = window.eventSequence;
            const progressManager = window.progressManager;
            const getStageStatus = window.getStageStatus;
            
            console.log('Objects loaded:', { 
                eventSequence: !!eventSequence, 
                progressManager: !!progressManager, 
                getStageStatus: !!getStageStatus 
            });
            
            if (!eventSequence || !progressManager || !getStageStatus) {
                console.error('Required objects not loaded yet');
                return;
            }
            
            console.log('Mapping eventSequence with', eventSequence.length, 'stages');
            
            try {
                timelineStages.innerHTML = eventSequence.map((stage, index) => {
                    const status = getStageStatus(stage.stage);
                    const isChoice = stage.type === 'choice';
                    
                    console.log(`Stage ${stage.stage}: status=${status}, isChoice=${isChoice}`);
                    
                    return `
                        <div class="timeline-stage ${status} ${isChoice ? 'choice-stage' : ''}" data-stage="${stage.stage}">
                            <div class="stage-dot"></div>
                            <div class="stage-label">
                                <div class="stage-number">Stage ${stage.stage}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('Timeline HTML generated, length:', timelineStages.innerHTML.length);
            } catch (error) {
                console.error('Error generating timeline HTML:', error);
                return;
            }

            // Position team car marker
            const currentStage = progressManager.getCurrentStage();
            console.log('Rendering timeline with currentStage:', currentStage);
            const stageElements = timelineStages.querySelectorAll('.timeline-stage');
            if (stageElements.length > 0) {
                const currentIndex = Math.min(currentStage - 1, stageElements.length - 1);
                const stageElement = stageElements[currentIndex];
                if (stageElement) {
                    const position = (currentIndex / (stageElements.length - 1)) * 100;
                    cyclistMarker.style.left = `${position}%`;
                    console.log(`Team car positioned at stage ${currentStage} (${position}%)`);
                }
            }
            
            console.log('=== renderTimeline COMPLETE ===');
        }

        // Render event sequence
        function renderEventSequence() {
            console.log('=== renderEventSequence START ===');
            const eventsSequence = document.getElementById('eventsSequence');
            
            console.log('eventsSequence element found:', !!eventsSequence);
            
            // Use window objects explicitly
            const eventSequence = window.eventSequence;
            const progressManager = window.progressManager;
            const getStageStatus = window.getStageStatus;
            const getEvent = window.getEvent;
            
            console.log('Objects loaded:', {
                eventSequence: !!eventSequence,
                progressManager: !!progressManager,
                getStageStatus: !!getStageStatus,
                getEvent: !!getEvent
            });
            
            if (!eventSequence || !progressManager || !getStageStatus || !getEvent) {
                console.error('Required objects not loaded yet for renderEventSequence');
                return;
            }
            
            // Helper function to calculate tour progress from user data
            async function getTourProgress() {
                if (!progressManager.currentUser) return { completed: 0, total: 3 };
                
                try {
                    const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const db = getFirestore();
                    const userDoc = await getDoc(doc(db, 'users', progressManager.currentUser.uid));
                    const userData = userDoc.data();
                    
                    // Count how many tour stages have results
                    let completed = 0;
                    if (userData?.event13Results) completed++;
                    if (userData?.event14Results) completed++;
                    if (userData?.event15Results) completed++;
                    
                    return { completed, total: 3 };
                } catch (error) {
                    console.error('Error getting tour progress:', error);
                    return { completed: 0, total: 3 };
                }
            }
            
            console.log('Mapping eventSequence with', eventSequence.length, 'stages');
            
            // Get tour progress first (async)
            getTourProgress().then(tourProgress => {
            
            try {
                eventsSequence.innerHTML = eventSequence.map((stage, index) => {
                    const status = getStageStatus(stage.stage);
                    const isChoice = stage.type === 'choice';
                    const isLocked = status === 'locked';
                    const isCompleted = status === 'completed';
                    
                    console.log(`Rendering stage ${stage.stage}: status=${status}, isChoice=${isChoice}`);
                    
                if (isChoice) {
                        // Choice stage
                        const selectedEventId = progressManager.getChoiceSelection(stage.stage);
                        const availableCount = progressManager.getAvailableOptionalEvents(stage.stage).length;
                        const selectedEvent = selectedEventId ? getEvent(selectedEventId) : null;
                    
                    return `
                        <div class="sequence-stage ${status}" data-stage="${stage.stage}">
                            <div class="stage-connector"></div>
                            <div class="stage-card choice-card">
                                <div class="stage-card-header">
                                    <span class="stage-number-badge">Stage ${stage.stage}</span>
                                    <span class="stage-type-badge choice">Rider's Choice</span>
                                </div>
                                ${selectedEvent ? `
                                ${selectedEvent.headerImage ? `
                                <div class="event-header-image-container">
                                    <img
                                        src="${selectedEvent.headerImage}"
                                        alt="${selectedEvent.name}"
                                        class="event-header-image"
                                        loading="lazy"
                                        onerror="this.parentElement.style.display='none'; this.parentElement.nextElementSibling.style.display='flex';"
                                    >
                                </div>
                                <div class="event-image" style="display: none;">
                                    <div class="event-image-placeholder">
                                        ${window.TPVIcons ? window.TPVIcons.getEventIcon(selectedEvent, 'xxl') : selectedEvent.icon}
                                    </div>
                                </div>
                                ` : `
                                <div class="event-image">
                                    <div class="event-image-placeholder">
                                        ${window.TPVIcons ? window.TPVIcons.getEventIcon(selectedEvent, 'xxl') : selectedEvent.icon}
                                    </div>
                                </div>
                                `}
                                ` : `
                                <div class="event-header-image-container">
                                    <img
                                        src="event-images/season1/riders_choice.jpg"
                                        alt="Rider's Choice"
                                        class="event-header-image"
                                        loading="lazy"
                                        onerror="this.parentElement.style.display='none'; this.parentElement.nextElementSibling.style.display='flex';"
                                    >
                                </div>
                                <div class="event-image" style="display: none;">
                                    <div class="event-image-placeholder">
                                        ${window.TPVIcons && stage.iconId ? window.TPVIcons.getIcon(stage.iconId, {size: 'xxl'}) : stage.icon}
                                    </div>
                                </div>
                                `}
                                <div class="stage-card-content">
                                    ${!selectedEvent ? `` : ''}
                                    <h3 class="stage-title">${selectedEvent ? selectedEvent.name : stage.name}</h3>
                                    <p class="stage-description">
                                        ${selectedEventId ? 
                                            `${selectedEvent.subtitle}` :
                                            `${availableCount} Rider's Choice events available`
                                        }
                                    </p>
                                    ${selectedEvent ? `
                                    <div class="event-stats">
                                        <div class="stat-item">
                                            <span class="stat-icon">üìç</span>
                                            <span>${selectedEvent.distance}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">${window.TPVIcons ? window.TPVIcons.getIcon('mountain', {size: 'sm'}) : '‚õ∞Ô∏è'}</span>
                                            <span>${selectedEvent.climbing}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">${window.TPVIcons ? window.TPVIcons.getIcon('achievement', {size: 'sm'}) : '‚≠ê'}</span>
                                            <span>${selectedEvent.maxPoints} pts</span>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="stage-card-footer">
                                    ${!isLocked && !isCompleted ? `<button class="btn btn-primary btn-full" onclick="openChoiceModal(${stage.stage})">Choose Event</button>` : ''}
                                    ${isCompleted && selectedEventId ? `<button class="btn btn-secondary btn-full" onclick="location.href='event-detail.html?id=${selectedEventId}'">View Results</button>` : ''}
                                    ${isCompleted ? '<span class="completed-badge">‚úì Completed</span>' : ''}
                                </div>
                                ${isLocked ? `<div class="locked-overlay"><span>${window.TPVIcons ? window.TPVIcons.getIcon('locked', {size: 'lg'}) : 'üîí'}</span><p>Complete previous stage to unlock</p></div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Mandatory stage
                    const event = getEvent(stage.eventId);
                    
                    // Check if this is the Local Tour (event 13-15)
                    const isTourEvent = stage.eventId >= 13 && stage.eventId <= 15;
                    let tourProgressBadge = '';
                    if (isTourEvent) {
                        // Use the tour progress from userData (already calculated above)
                        tourProgressBadge = `<div class="tour-progress-badge">${tourProgress.completed} of 3 stages completed</div>`;
                    }
                    
                    return `
                        <div class="sequence-stage ${status}" data-stage="${stage.stage}">
                            <div class="stage-connector"></div>
                            <div class="stage-card event-card-sequential">
                                <div class="stage-card-header">
                                    <span class="stage-number-badge">Stage ${stage.stage}</span>
                                    <span class="stage-type-badge mandatory">Mandatory</span>
                                </div>
                                ${isTourEvent ? tourProgressBadge : ''}
                                ${event.headerImage ? `
                                <div class="event-header-image-container">
                                    <img
                                        src="${event.headerImage}"
                                        alt="${event.name}"
                                        class="event-header-image"
                                        loading="lazy"
                                        onerror="this.parentElement.style.display='none'; this.parentElement.nextElementSibling.style.display='flex';"
                                    >
                                </div>
                                <div class="event-image" style="display: none;">
                                    <div class="event-image-placeholder">
                                        ${window.TPVIcons ? window.TPVIcons.getEventIcon(event, 'xxl') : event.icon}
                                    </div>
                                </div>
                                ` : `
                                <div class="event-image">
                                    <div class="event-image-placeholder">
                                        ${window.TPVIcons ? window.TPVIcons.getEventIcon(event, 'xxl') : event.icon}
                                    </div>
                                </div>
                                `}
                                <div class="stage-card-content">
                                    <h3 class="stage-title">${event.name}</h3>
                                    <p class="stage-description">${event.subtitle}</p>
                                    <div class="event-stats">
                                        <div class="stat-item">
                                            <span class="stat-icon">üìç</span>
                                            <span>${event.distance}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">${window.TPVIcons ? window.TPVIcons.getIcon('mountain', {size: 'sm'}) : '‚õ∞Ô∏è'}</span>
                                            <span>${event.climbing}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">${window.TPVIcons ? window.TPVIcons.getIcon('achievement', {size: 'sm'}) : '‚≠ê'}</span>
                                            <span>${event.maxPoints} pts</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="stage-card-footer">
                                    ${!isLocked ? `<button class="btn btn-secondary btn-full" onclick="location.href='${isTourEvent ? 'local-tour.html' : `event-detail.html?id=${stage.eventId}`}'">${isCompleted ? 'View Results' : 'View Details'}</button>` : ''}
                                    ${isCompleted && tourProgress.completed === 3 ? '<span class="completed-badge">‚úì Completed</span>' : isCompleted && !isTourEvent ? '<span class="completed-badge">‚úì Completed</span>' : ''}
                                </div>
                                ${isLocked ? `<div class="locked-overlay"><span>${window.TPVIcons ? window.TPVIcons.getIcon('locked', {size: 'lg'}) : 'üîí'}</span><p>Complete previous stage to unlock</p></div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            console.log('EventSequence HTML generated, length:', eventsSequence.innerHTML.length);
            console.log('=== renderEventSequence COMPLETE ===');
        } catch (error) {
            console.error('Error in renderEventSequence:', error);
        }
            }); // End of getTourProgress().then()
        }

        // Update progress stats
        async function updateProgressStats() {
            const progressManager = window.progressManager;
            const eventSequence = window.eventSequence;
            
            if (!progressManager || !eventSequence) {
                console.error('Required objects not loaded yet in updateProgressStats');
                return;
            }
            
            const current = progressManager.getCurrentStage();
            const completed = progressManager.progress.completedStages.length;
            const total = eventSequence.length;
            const points = progressManager.getTotalPoints();
            
            document.getElementById('currentStageText').textContent = `Stage ${current}`;
            document.getElementById('completedStagesText').textContent = `${completed} / ${total}`;
            document.getElementById('pointsEarnedText').textContent = points.toString();
            
            // Fetch and display season rank
            await updateSeasonRank();
            
            // Update season story/report
            await updateSeasonStory();
        }
        
        // Fetch and display user's season rank
        async function updateSeasonRank() {
            const rankText = document.getElementById('seasonRankText');
            
            // Check if user is logged in
            if (!progressManager.currentUser) {
                rankText.textContent = '-';
                return;
            }
            
            try {
                // Import Firebase functions
                const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore();
                
                // Fetch user data - same as standings page does
                const userDoc = await getDoc(doc(db, 'users', progressManager.currentUser.uid));
                const userData = userDoc.data();
                
                // Check if we have season standings data
                let standings = userData?.season1Standings;
                
                if (!standings || standings.length === 0) {
                    // No standings data yet
                    rankText.textContent = '-';
                    return;
                }
                
                // Find current user in standings (marked with isCurrentUser: true)
                const userPosition = standings.findIndex(racer => racer.isCurrentUser === true);
                
                if (userPosition === -1) {
                    rankText.textContent = '-';
                    return;
                }
                
                // Format position with ordinal suffix
                const rank = userPosition + 1;
                const suffix = getRankSuffix(rank);
                rankText.textContent = `${rank}${suffix}`;
                
            } catch (error) {
                console.error('Error fetching season rank:', error);
                rankText.textContent = '-';
            }
        }
        
        // Check if user is an admin
        async function checkAdminStatus() {
            if (!progressManager.currentUser) {
                return false;
            }
            
            try {
                const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore();
                
                const userDoc = await getDoc(doc(db, 'users', progressManager.currentUser.uid));
                const userData = userDoc.data();
                
                return userData?.isAdmin === true;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }
        
        // Update season story or end-of-season report
        async function updateSeasonStory() {
            const storyContent = document.getElementById('seasonStoryContent');
            
            // Check if element exists
            if (!storyContent) {
                console.error('seasonStoryContent element not found');
                return;
            }
            
            // Check if required objects are available
            if (typeof window.eventSequence === 'undefined' || typeof window.progressManager === 'undefined') {
                console.log('Waiting for eventSequence and progressManager to load...');
                // Set a default message while loading
                storyContent.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading...</p>';
                return;
            }
            
            // Use window.eventSequence and window.progressManager to be explicit
            const eventSequence = window.eventSequence;
            const progressManager = window.progressManager;
            
            // Check if season is complete (all 9 stages completed)
            const totalStages = eventSequence.length;
            const completedStages = progressManager.progress.completedStages.length;
            
            // Special check for Local Tour (stage 9 = events 13, 14, 15)
            // Even if stage 9 is marked complete, we need to verify all 3 tour stages are done
            // OR if the tour was DNS'd due to 36-hour window violations
            let isSeasonComplete = completedStages === totalStages;
            let tourDNS = false;
            
            if (isSeasonComplete && progressManager.currentUser) {
                // Additional check: verify Local Tour is fully complete or DNS
                try {
                    const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const db = getFirestore();
                    const userDoc = await getDoc(doc(db, 'users', progressManager.currentUser.uid));
                    const userData = userDoc.data();
                    
                    // Check if all 3 Local Tour stages are completed
                    const event13Complete = userData?.event13Results;
                    const event14Complete = userData?.event14Results;
                    const event15Complete = userData?.event15Results;
                    
                    const tourComplete = event13Complete && event14Complete && event15Complete;
                    
                    // Check for DNS (Did Not Start) - if a stage is marked DNS or wasn't completed in time
                    if (event13Complete) {
                        // Check if stage 2 or 3 are marked as DNS
                        tourDNS = userData?.event14DNS || userData?.event15DNS;
                        
                        // Also check if enough time has passed without completing the stages
                        // If event 13 was done but 14/15 are missing and more than 36 hours passed, it's effectively DNS
                        if (!tourDNS && !event14Complete && event13Complete.timestamp) {
                            const event13Time = event13Complete.timestamp?.toMillis ? event13Complete.timestamp.toMillis() : event13Complete.timestamp;
                            const now = Date.now();
                            const hoursPassed = (now - event13Time) / (1000 * 60 * 60);

                            if (hoursPassed > 36) {
                                tourDNS = true;
                                console.log('Event 14 DNS - 36 hour window expired');
                            }
                        }
                        
                        if (!tourDNS && event14Complete && !event15Complete && event14Complete.timestamp) {
                            const event14Time = event14Complete.timestamp?.toMillis ? event14Complete.timestamp.toMillis() : event14Complete.timestamp;
                            const now = Date.now();
                            const hoursPassed = (now - event14Time) / (1000 * 60 * 60);

                            if (hoursPassed > 36) {
                                tourDNS = true;
                                console.log('Event 15 DNS - 36 hour window expired');
                            }
                        }
                    }
                    
                    if (!tourComplete && !tourDNS) {
                        isSeasonComplete = false;
                        console.log('Season appears complete but Local Tour not finished - treating as incomplete');
                    } else if (tourDNS) {
                        isSeasonComplete = true;
                        console.log('Local Tour DNS - season considered complete with incomplete tour');
                    }
                } catch (error) {
                    console.error('Error checking Local Tour completion:', error);
                }
            }
            
            console.log(`Season status: ${completedStages}/${totalStages} stages completed, isSeasonComplete: ${isSeasonComplete}, tourDNS: ${tourDNS}`);
            
            if (!isSeasonComplete) {
                // Show introduction text
                storyContent.innerHTML = '<p>This is the true beginning of your career - the moment where you stop imagining what it would feel like to "be a rider" and actually step into it. The races may be small, the crowds may be local, but every start line feels electric because you are finally part of it. This is your chance to experience that classic pro cycling manager journey, only now it is you doing the riding, you making the decisions, and you earning every result with your own legs. At this level, every race is an opportunity: the crits sharpen your instincts, the climbs test your composure, and the time trials reveal what you are really capable of when it is just you against the clock. Nothing is handed to you, but that is the appeal - each place you gain, each expectation you beat, feels like your first steps toward something bigger. You are not chasing fame yet; you are chasing proof that you belong here. It is the start of a long road, but a meaningful one. And if you can master these early races - these local, gritty, character-building tests - you will lay the foundation for everything that comes next. This is not just a season. It is the pro cyclist origin story you have always imagined, and you are finally writing the first chapter.</p>';
                storyContent.classList.remove('report');
                console.log('Season introduction text loaded');
            } else {
                // Season is complete - show appropriate end-of-season report
                await showEndOfSeasonReport(storyContent);
            }
        }
        
        // Show end-of-season report based on final ranking
        async function showEndOfSeasonReport(storyContent) {
            try {
                // Get user's final rank
                const { getFirestore, doc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore();
                
                if (!progressManager.currentUser) {
                    storyContent.innerHTML = '<p>Complete the season to see your final report!</p>';
                    return;
                }
                
                // Fetch user data
                const userDocRef = doc(db, 'users', progressManager.currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                const userData = userDoc.data();
                
                if (!userData) {
                    storyContent.innerHTML = '<p>Loading season data...</p>';
                    return;
                }
                
                // Use the new season completion module
                if (window.seasonCompletion) {
                    const summaryText = window.seasonCompletion.generateSeasonSummaryText(userData);
                    storyContent.innerHTML = `<p>${summaryText}</p>`;
                    storyContent.classList.add('report');
                    
                    // Show season complete banner
                    if (window.seasonCompletionUI) {
                        window.seasonCompletionUI.showSeasonCompleteBanner(userData, summaryText);
                        
                        // Show celebration modal if not seen yet
                        if (window.seasonCompletionUI.shouldShowCelebration(userData)) {
                            const seasonData = {
                                seasonRank: userData.season1Rank || null,
                                totalPoints: userData.season1Points || 0,
                                totalWins: userData.season1Wins || 0,
                                totalPodiums: userData.season1Podiums || 0,
                                totalEvents: (userData.completedStages || []).length,
                                localTourGCPosition: userData.localTourGCPosition,
                                earnedSeasonPodium: userData.season1Rank <= 3,
                                awards: userData.awards || {}
                            };
                            window.seasonCompletionUI.showSeasonCompleteModal(seasonData);
                            
                            // Mark as viewed
                            await updateDoc(userDocRef, { season1CelebrationViewed: true });
                        }
                    }
                } else {
                    // Fallback if modules not loaded
                    storyContent.innerHTML = '<p>Season 1 is complete! Congratulations on finishing all events.</p>';
                    storyContent.classList.add('report');
                }
                
            } catch (error) {
                console.error('Error showing end-of-season report:', error);
                storyContent.innerHTML = '<p>Season complete! Your final standings are being calculated.</p>';
                storyContent.classList.add('report');
            }
        }
        
        // Helper function to get ordinal suffix
        function getRankSuffix(rank) {
            if (rank >= 11 && rank <= 13) return 'th';
            const lastDigit = rank % 10;
            if (lastDigit === 1) return 'st';
            if (lastDigit === 2) return 'nd';
            if (lastDigit === 3) return 'rd';
            return 'th';
        }

        // Open choice modal
        function openChoiceModal(stage) {
            const progressManager = window.progressManager;
            const getEvent = window.getEvent;
            
            if (!progressManager || !getEvent) {
                console.error('Required objects not loaded yet');
                return;
            }
            
            const modal = document.getElementById('choiceModal');
            const grid = document.getElementById('choiceEventsGrid');
            const availableEvents = progressManager.getAvailableOptionalEvents(stage);
            
            grid.innerHTML = availableEvents.map(eventId => {
                const event = getEvent(eventId);
                const iconHtml = window.TPVIcons ? window.TPVIcons.getEventIcon(event, 'xl') : event.icon;

                // Build header image or fallback to icon
                const headerHtml = event.headerImage ? `
                    <div class="choice-event-image-container">
                        <img
                            src="${event.headerImage}"
                            alt="${event.name}"
                            class="choice-event-image"
                            loading="lazy"
                            onerror="this.parentElement.style.display='none'; this.parentElement.nextElementSibling.style.display='block';"
                        >
                    </div>
                    <div class="choice-event-icon" style="display: none;">${iconHtml}</div>
                ` : `
                    <div class="choice-event-icon">${iconHtml}</div>
                `;

                return `
                    <div class="choice-event-card" onclick="selectChoiceEvent(${stage}, ${eventId})">
                        ${headerHtml}
                        <div class="choice-event-content">
                            <h4>${event.name}</h4>
                            <p>${event.subtitle}</p>
                            <div class="choice-event-stats">
                                <span>üìç ${event.distance}</span>
                                <span>${window.TPVIcons ? window.TPVIcons.getIcon('mountain', {size: 'sm'}) : '‚õ∞Ô∏è'} ${event.climbing}</span>
                                <span>${window.TPVIcons ? window.TPVIcons.getIcon('achievement', {size: 'sm'}) : '‚≠ê'} ${event.maxPoints} pts</span>
                            </div>
                            <button class="btn btn-primary btn-small">Select</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Store current choice stage
            modal.dataset.choiceStage = stage;
        }

        // Select choice event
        function selectChoiceEvent(stage, eventId) {
            closeChoiceModal();
            // Redirect to event detail page for the selected event
            location.href = `event-detail.html?id=${eventId}&stage=${stage}&choice=true`;
        }

        // Close choice modal
        function closeChoiceModal() {
            const modal = document.getElementById('choiceModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired');

            // Initialize progress card icons
            if (window.TPVIcons) {
                const progressIcons = {
                    'progressIconStage': 'eventRoadRace',
                    'progressIconCompleted': 'checkmark',
                    'progressIconPoints': 'achievement',
                    'progressIconRank': 'trophy'
                };
                Object.entries(progressIcons).forEach(([elemId, iconId]) => {
                    const el = document.getElementById(elemId);
                    if (el) el.innerHTML = window.TPVIcons.getIcon(iconId, { size: 'lg' });
                });
            }

            // Setup modal close handlers
            document.getElementById('choiceModalClose').addEventListener('click', closeChoiceModal);
            document.getElementById('choiceModalOverlay').addEventListener('click', closeChoiceModal);
            
            // Wait for event-sequence.js module to load and attach to window
            const initializeUI = async () => {
                console.log('Checking for required objects...', {
                    eventSequence: typeof window.eventSequence,
                    progressManager: typeof window.progressManager,
                    getStageStatus: typeof window.getStageStatus,
                    getEvent: typeof window.getEvent
                });
                
                if (typeof window.eventSequence === 'undefined' || typeof window.progressManager === 'undefined') {
                    // Module not loaded yet, wait a bit
                    console.log('Waiting for modules to load...');
                    setTimeout(initializeUI, 50);
                    return;
                }
                
                console.log('All required objects loaded!');
                console.log('Event sequence length:', window.eventSequence.length);
                console.log('Progress Manager:', window.progressManager);
                
                try {
                    // Admin toggle will be shown by updateProgressUI when auth is ready
                    
                    console.log('Calling renderTimeline...');
                    renderTimeline();
                    
                    console.log('Calling renderEventSequence...');
                    renderEventSequence();
                    
                    console.log('Calling updateProgressStats...');
                    updateProgressStats();

                    // Add click handler for team car to scroll to next event
                    const cyclistMarker = document.getElementById('cyclistMarker');
                    if (cyclistMarker) {
                        cyclistMarker.addEventListener('click', scrollToNextEvent);
                    }

                    console.log('UI initialization complete!');
                } catch (error) {
                    console.error('Error during UI initialization:', error);
                }
            };

            initializeUI();
        });

        // Scroll to the next available event
        function scrollToNextEvent() {
            const progressManager = window.progressManager;
            if (!progressManager) return;

            const currentStage = progressManager.getCurrentStage();

            // Find the stage card for the current stage (the next one to complete)
            const stageCard = document.querySelector(`.sequence-stage[data-stage="${currentStage}"]`);

            if (stageCard) {
                stageCard.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        // Global function to update UI when progress changes (called by Firebase)
        window.updateProgressUI = async function() {
            console.log('Updating UI after Firebase progress load');

            // Check admin status now that user is authenticated
            await checkAndShowAdminToggle();

            // Load user data and update season switcher
            try {
                const progressManager = window.progressManager;
                if (progressManager?.currentUser) {
                    const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const db = getFirestore();
                    const userDoc = await getDoc(doc(db, 'users', progressManager.currentUser.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        updateSeasonSwitcherWithUserData(userData);
                    }
                }
            } catch (err) {
                console.warn('Error loading user data for season switcher:', err);
            }

            renderTimeline();
            renderEventSequence();
            updateProgressStats();
        };
        
        // Admin toggle setup - called when auth is ready
        async function checkAndShowAdminToggle() {
            const isAdmin = await checkAdminStatus();
            const adminToggle = document.getElementById('adminToggle');
            
            if (isAdmin && adminToggle) {
                adminToggle.style.display = 'inline-block';
                
                // Only add listener once
                if (!adminToggle.hasAttribute('data-listener-added')) {
                    adminToggle.setAttribute('data-listener-added', 'true');
                    adminToggle.addEventListener('click', () => {
                        const progressManager = window.progressManager;
                        if (!progressManager) return;
                        
                        progressManager.setAdminMode(!progressManager.isAdmin);
                        document.getElementById('adminStatus').textContent = 
                            progressManager.isAdmin ? 'Admin Mode: ON' : 'Admin Mode: OFF';
                        renderEventSequence();
                        renderTimeline();
                    });
                }
            }
        }

        // Make functions global for onclick handlers
        window.openChoiceModal = openChoiceModal;
        window.selectChoiceEvent = selectChoiceEvent;

        // Season Switcher - will be initialized once and updated when user data loads
        let seasonSwitcher = null;
        let viewingSeason = 1; // Track which season we're viewing

        // Initialize season switcher with defaults (before user data loads)
        function initSeasonSwitcher() {
            if (!window.SeasonSwitcher) {
                console.warn('SeasonSwitcher not loaded');
                return;
            }

            // Get initial viewing season from URL or localStorage
            viewingSeason = window.getViewingSeasonFromUrl ?
                window.getViewingSeasonFromUrl(1) : 1;

            seasonSwitcher = new window.SeasonSwitcher({
                containerId: 'seasonSwitcherContainer',
                userData: null, // Will be updated when user data loads
                currentSeason: 1,
                viewingSeason: viewingSeason,
                showLabels: true,
                onSeasonChange: handleSeasonChange
            });

            seasonSwitcher.render();
        }

        // Handle season change from the switcher
        function handleSeasonChange(newSeason) {
            console.log(`Season ${newSeason} selected`);
            viewingSeason = newSeason;

            // Update the history banner
            updateSeasonHistoryBanner();

            // Re-render the page for the selected season
            renderTimeline();
            renderEventSequence();
            updateProgressStats();
            updateSeasonStory();
        }

        // Show/hide history banner when viewing a past completed season
        function updateSeasonHistoryBanner() {
            const banner = document.getElementById('seasonHistoryBanner');
            if (!banner) return;

            // Only show banner if viewing a completed past season
            if (seasonSwitcher && seasonSwitcher.isViewingHistory()) {
                const seasonConfig = window.seasonConfig?.getSeasonConfig?.(viewingSeason);
                const seasonName = seasonConfig ?
                    `${seasonConfig.name} - ${seasonConfig.subtitle}` :
                    `Season ${viewingSeason}`;

                banner.innerHTML = `
                    <div class="season-history-banner">
                        <span class="season-history-banner__text">
                            <strong>Viewing History:</strong> ${seasonName} (Completed)
                        </span>
                        ${window.createReturnToCurrentButton ?
                            window.createReturnToCurrentButton(seasonSwitcher.currentSeason, (s) => {
                                seasonSwitcher.update({ viewingSeason: s });
                                handleSeasonChange(s);
                            }) : ''
                        }
                    </div>
                `;
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }

        // Update season switcher when user data is available
        function updateSeasonSwitcherWithUserData(userData) {
            if (!seasonSwitcher) {
                initSeasonSwitcher();
            }

            if (seasonSwitcher) {
                const currentSeason = userData?.currentSeason || 1;
                seasonSwitcher.update({
                    userData: userData,
                    currentSeason: currentSeason,
                    viewingSeason: viewingSeason
                });
                updateSeasonHistoryBanner();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSeasonSwitcher();
        });

        // Legacy support - keep selectSeason for any old references
        window.selectSeason = function(seasonNumber) {
            if (seasonSwitcher) {
                seasonSwitcher.update({ viewingSeason: parseInt(seasonNumber) });
                handleSeasonChange(parseInt(seasonNumber));
            }
        };
        
        // Season 1 Reset Function
        window.resetSeason1 = async function() {
            if (!progressManager.currentUser) {
                alert('You must be logged in to reset your season.');
                return;
            }
            
            try {
                const { getFirestore, doc, updateDoc, deleteField, collection, query, where, getDocs, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore();
                
                // Find user document
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', progressManager.currentUser.email));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    alert('User data not found.');
                    return;
                }
                
                const userDoc = querySnapshot.docs[0];
                const userDocRef = userDoc.ref;
                const userData = userDoc.data();
                const userUid = userData.uid;

                // Calculate new career points: remove season points, add 50 bonus
                const currentCareerPoints = userData.careerPoints || 0;
                const currentSeasonPoints = userData.season1Points || userData.totalPoints || 0;
                const newCareerPoints = currentCareerPoints - currentSeasonPoints + 50;

                // Calculate all career stats from special events only (events > 100)
                // Season event contributions are being reset, but special event contributions remain
                let newCareerEvents = 0;
                let newCareerWins = 0;
                let newCareerPodiums = 0;
                let newCareerTop10s = 0;
                let newCareerBestFinish = null;
                let careerPositions = [];

                for (let eventNum = 101; eventNum <= 110; eventNum++) {
                    const eventResults = userData[`event${eventNum}Results`];
                    if (eventResults && eventResults.position && eventResults.position !== 'DNF') {
                        const position = eventResults.position;
                        newCareerEvents++;
                        careerPositions.push(position);

                        if (position === 1) {
                            newCareerWins++;
                        }
                        if (position <= 3) {
                            newCareerPodiums++;
                        }
                        if (position <= 10) {
                            newCareerTop10s++;
                        }
                        if (newCareerBestFinish === null || position < newCareerBestFinish) {
                            newCareerBestFinish = position;
                        }
                    }
                }

                // Calculate derived career stats
                let newCareerAvgFinish = null;
                let newCareerWinRate = 0;
                let newCareerPodiumRate = 0;
                if (newCareerEvents > 0) {
                    const totalPositions = careerPositions.reduce((sum, pos) => sum + pos, 0);
                    newCareerAvgFinish = parseFloat((totalPositions / newCareerEvents).toFixed(1));
                    newCareerWinRate = parseFloat(((newCareerWins / newCareerEvents) * 100).toFixed(1));
                    newCareerPodiumRate = parseFloat(((newCareerPodiums / newCareerEvents) * 100).toFixed(1));
                }

                // Delete all race result documents for this user (season1_event1_UID through season1_event15_UID)
                const deletePromises = [];
                for (let i = 1; i <= 15; i++) {
                    const resultDocId = `season1_event${i}_${userUid}`;
                    const resultDocRef = doc(db, 'results', resultDocId);
                    deletePromises.push(
                        deleteDoc(resultDocRef).catch(err => {
                            // Silently catch if document doesn't exist
                            if (err.code !== 'not-found') {
                                console.warn(`Failed to delete ${resultDocId}:`, err);
                            }
                        })
                    );
                }
                
                // Wait for all result deletions to complete
                await Promise.all(deletePromises);
                
                // Reset all season 1 data
                const resetData = {
                    currentStage: 1,
                    // Career statistics (recalculated from special events only)
                    careerPoints: newCareerPoints,
                    careerEvents: newCareerEvents,
                    careerWins: newCareerWins,
                    careerPodiums: newCareerPodiums,
                    careerTop10s: newCareerTop10s,
                    careerBestFinish: newCareerBestFinish,
                    careerAvgFinish: newCareerAvgFinish,
                    careerWinRate: newCareerWinRate,
                    careerPodiumRate: newCareerPodiumRate,
                    // Season 1 statistics (reset to 0)
                    season1Events: 0,
                    season1Wins: 0,
                    season1Podiums: 0,
                    season1Top10s: 0,
                    season1Points: 0,
                    season1BestFinish: null,
                    season1AvgFinish: null,
                    season1WinRate: 0,
                    season1PodiumRate: 0,
                    // Season progression
                    completedStages: [],
                    usedOptionalEvents: [],
                    tourProgress: {},
                    season1Standings: [],
                    season1Complete: false,
                    season1Rank: null,
                    localTourStatus: 'in_progress',
                    season1CelebrationViewed: false,
                    gluttonForPunishmentAwarded: true,
                    // Reset cadence credits but award 100 CC for Glutton for Punishment
                    currency: {
                        balance: 100,
                        totalEarned: 100,
                        transactions: [{
                            id: 'cc_glutton_for_punishment',
                            type: 'earn',
                            delta: 100,
                            source: 'award',
                            awardId: 'gluttonForPunishment',
                            timestamp: new Date()
                        }]
                    },
                    // Reset unlocks (shop purchases)
                    unlocks: {
                        inventory: [],
                        equipped: [],
                        slotCount: 1,
                        cooldowns: {}
                    },
                    awards: {
                        gold: 0,
                        silver: 0,
                        bronze: 0,
                        punchingMedal: 0,
                        giantKiller: 0,
                        bullseye: 0,
                        hotStreak: 0,
                        domination: 0,
                        closeCall: 0,
                        photoFinish: 0,
                        darkHorse: 0,
                        zeroToHero: 0,
                        gcGold: 0,
                        gcSilver: 0,
                        gcBronze: 0,
                        lanternRouge: 0,
                        seasonChampion: 0,
                        seasonRunnerUp: 0,
                        seasonThirdPlace: 0,
                        gluttonForPunishment: 1
                    }
                };
                
                // Delete all event results and DNS flags
                const deleteFields = {};
                for (let i = 1; i <= 15; i++) {
                    deleteFields[`event${i}Results`] = deleteField();
                }
                deleteFields.event14DNS = deleteField();
                deleteFields.event15DNS = deleteField();
                deleteFields.event14DNSReason = deleteField();
                deleteFields.event15DNSReason = deleteField();
                deleteFields.season1CompletionDate = deleteField();
                deleteFields.localTourGCPosition = deleteField();
                deleteFields.rivalData = deleteField();
                deleteFields.rivals = deleteField();
                deleteFields.rivalWins = deleteField();
                deleteFields.rivalLosses = deleteField();

                // Update user document
                await updateDoc(userDocRef, { ...resetData, ...deleteFields });
                
                console.log('Season 1 reset successful');
                
            } catch (error) {
                console.error('Error resetting season:', error);
                throw error;
            }
        };
    </script>
    <script src="season-completion.js"></script>
    <script src="season-completion-ui.js"></script>
    <script src="notification-queue.js"></script>
    <script src="achievement-notifications.js"></script>
    <script type="module" src="cadence-credits.js"></script>
    <script type="module" src="analytics.js"></script>
</body>
</html>
