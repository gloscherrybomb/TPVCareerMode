<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Detail - TPV Career Mode</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="tpv-team-car.png">
    <link rel="apple-touch-icon" href="tpv-team-car.png">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="event-detail.css">
    <link rel="stylesheet" href="achievement-notifications.css">
    <link rel="stylesheet" href="cadence-credits.css">
    <link rel="stylesheet" href="unlock-card.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-text">TPV</span>
                <span class="logo-subtitle">Career Mode</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="events.html" class="nav-link">Season</a>
                <a href="standings.html" class="nav-link">Standings</a>
                <a href="peloton.html" class="nav-link">Peloton</a>
                <a href="profile.html" class="nav-link">Profile</a>
                <a href="#" class="nav-link nav-login" id="loginBtn">Login</a>
                <a href="#" class="nav-link nav-logout" id="logoutBtn" style="display: none;">Logout</a>
                <a href="#" class="nav-link nav-support" id="supportBtn" style="display: none;" title="Support TPV Career Mode">&#9733;</a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <div class="event-hero section-loading">
        <div class="hero-background"></div>
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html">Home</a> / <a href="events.html">Events</a> / Event 01
            </div>
            <div class="event-hero-content">
                <div class="event-badge">Event 01 ‚Ä¢ Local Amateur</div>
                <h1 class="event-hero-title">The First Pedal</h1>
                <p class="event-hero-subtitle">Your journey begins on familiar roads</p>
            </div>
        </div>
    </div>

    <section class="event-overview section-loading">
        <div class="container">
            <div class="overview-grid">
                <div class="overview-card">
                    <div class="overview-icon">üìç</div>
                    <div class="overview-label">Distance</div>
                    <div class="overview-value">45 km</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">‚è±Ô∏è</div>
                    <div class="overview-label">Est. Time</div>
                    <div class="overview-value">~75 min</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">‚õ∞Ô∏è</div>
                    <div class="overview-label">Elevation</div>
                    <div class="overview-value">420 m</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">üéØ</div>
                    <div class="overview-label">Difficulty</div>
                    <div class="overview-value">Moderate</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Cadence Credits Section - Collapsible -->
    <section class="event-cc-section" id="eventCCSection" style="display: none;">
        <div class="container">
            <div class="cc-section-header">
                <div class="cc-section-title-area">
                    <h2 class="section-title-medium">
                        <span class="cc-section-icon">‚ö°</span>
                        Bonus Upgrades
                    </h2>
                    <p class="cc-section-subtitle">Choose upgrades to apply for a potential points bonus</p>
                </div>
                <button class="cc-section-toggle" id="ccSectionToggle" aria-label="Toggle Bonus Upgrades section">
                    <span class="cc-toggle-text">Hide</span>
                    <span class="cc-toggle-icon">‚ñº</span>
                </button>
            </div>

            <div class="cc-section-content" id="ccSectionContent">
                <!-- Pre-Race: Active Upgrades Display -->
                <div class="cc-content-pre-race" id="ccPreRaceContent">
                    <div id="cc-unlock-selector"></div>
                    <div class="cc-inline-editor-trigger">
                        <button class="cc-edit-loadout-btn" id="ccEditLoadoutBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <span>Manage Loadout</span>
                        </button>
                    </div>
                </div>

                <!-- Post-Race: Results Display -->
                <div class="cc-content-post-race" id="ccPostRaceContent">
                    <div id="cc-results-panel"></div>
                </div>
            </div>
        </div>
    </section>

    <section class="event-story section-loading">
        <div class="container">
            <div class="story-content">
                <h2 class="story-title">The Story</h2>
                <div class="story-text">
                    <p>Every champion started somewhere. For you, that somewhere is here‚Äîon the winding roads of your local circuit, where dreams are tested against reality, and potential meets pavement.</p>

                    <p>The morning air is crisp as you line up with dozens of other hopefuls. Some have been racing these roads for years. Others, like you, are just beginning to understand what it means to push beyond comfort, to find that extra gear when your body screams to stop.</p>

                    <p>This isn't just a race. It's a declaration. A statement that you're willing to chase something greater than easy victories and comfortable rides. The peloton ahead doesn't know your name yet, but they will.</p>

                    <p>Today, you take your first pedal stroke toward greatness. The road is long, and the journey has just begun. But in this moment, on this familiar circuit, you have everything you need: your bike, your determination, and the courage to start.</p>

                    <div class="story-callout">
                        <div class="callout-icon">üí°</div>
                        <div class="callout-text">
                            <strong>Race Strategy:</strong> Pace yourself carefully. The temptation to go out fast is strong, but conservation is key. Stay in the draft, watch for attacks in the final 10km, and save your sprint for when it counts.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Post-Race Interview Section -->
    <section class="post-race-interview" id="postRaceInterviewSection" style="display: none;">
        <div class="container">
            <div class="interview-container">
                <div class="interview-header">
                    <h2 class="interview-title">POST-RACE INTERVIEW</h2>
                    <button class="interview-toggle-btn" id="interviewToggleBtn" style="display: none;">
                        <span class="toggle-text">Show Interview</span>
                        <span class="toggle-icon">‚ñº</span>
                    </button>
                </div>

                <div class="interview-layout" id="interviewLayout">
                    <div class="journalist-avatar">
                        <img src="journalist.png" alt="Journalist">
                    </div>

                    <div class="interview-content">
                        <div class="journalist-question-wrapper">
                            <p class="journalist-question" id="journalistQuestion">
                                <!-- Question will be populated by JavaScript -->
                            </p>
                        </div>

                        <div class="response-options" id="responseOptions">
                            <!-- Response options will be populated by JavaScript -->
                        </div>

                        <!-- Submitted response feedback -->
                        <div class="interview-submitted" id="interviewSubmitted" style="display: none;">
                            <div class="submitted-response">
                                <p class="submitted-label">Your response:</p>
                                <p class="submitted-text" id="submittedText"></p>
                            </div>
                            <div class="personality-feedback">
                                <p class="feedback-label">This response affected your personality profile:</p>
                                <div class="personality-changes" id="personalityChanges"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Route Profile Section -->
    <section class="event-route section-loading" id="routeSection">
        <div class="container">
            <h2 class="section-title-medium" id="routeTitle">Route Profile</h2>
            
            <!-- Stage Switcher (only shown for stage races) -->
            <div class="stage-switcher" id="stageSwitcher" style="display: none;">
                <button class="stage-btn active" data-stage="0">Stage 1</button>
                <button class="stage-btn" data-stage="1">Stage 2</button>
                <button class="stage-btn" data-stage="2">Stage 3</button>
            </div>
            
            <div class="route-profile-container">
                <canvas id="elevationProfileCanvas" width="1200" height="400"></canvas>
            </div>
        </div>
    </section>

    <section class="event-scoring section-loading">
        <div class="container">
            <h2 class="section-title-medium">Scoring System</h2>
            <div class="scoring-grid">
                <div class="scoring-card">
                    <div class="scoring-rank">1st</div>
                    <div class="scoring-points">100 pts</div>
                </div>
                <div class="scoring-card">
                    <div class="scoring-rank">2nd</div>
                    <div class="scoring-points">85 pts</div>
                </div>
                <div class="scoring-card">
                    <div class="scoring-rank">3rd</div>
                    <div class="scoring-points">75 pts</div>
                </div>
                <div class="scoring-card">
                    <div class="scoring-rank">4th</div>
                    <div class="scoring-points">70 pts</div>
                </div>
                <div class="scoring-card">
                    <div class="scoring-rank">5th</div>
                    <div class="scoring-points">65 pts</div>
                </div>
                <div class="scoring-card">
                    <div class="scoring-rank">6th-10th</div>
                    <div class="scoring-points">60-50 pts</div>
                </div>
                <div class="scoring-card">
                    <div class="scoring-rank">11th-20th</div>
                    <div class="scoring-points">45-30 pts</div>
                </div>
                <div class="scoring-card">
                    <div class="scoring-rank">Completion</div>
                    <div class="scoring-points">25 pts</div>
                </div>
            </div>
            <p class="scoring-note">Points are awarded based on your finishing position. Complete the event to unlock the next challenge.</p>
        </div>
    </section>

    <section class="event-cta section-loading">
        <div class="container">
            <div class="cta-box" id="ctaBox">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Event Results Section -->
    <section class="event-results" id="eventResultsSection" style="display: none;">
        <div class="container">
            <h2 class="section-title-medium">Event Results</h2>
            <div id="eventResultsContent">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">TPV Career Mode</div>
                    <p>Virtual cycling career progression</p>
                </div>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Season</a>
                    <a href="standings.html">Standings</a>
                    <a href="peloton.html">Peloton</a>
                    <a href="beginners-guide.html">Beginner's Guide</a>
                    <a href="about.html">About</a>
                    <a href="privacy.html">Privacy</a>
                    <a href="upload-results.html" id="upload-results-link" style="display: none;">Upload Results</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 TPV Career Mode. TPV Career Mode is a community effort completely independent from TrainingPeaks and TrainingPeaks Virtual.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <h2 class="modal-title">Welcome Back</h2>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="login">Login</button>
                <button class="modal-tab" data-tab="signup">Sign Up</button>
            </div>
            
            <div class="tab-content active" id="loginTab">
                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="form-group-checkbox">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe" checked>
                            <span class="checkbox-text">Remember me</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Login</button>
                </form>
                <div class="auth-divider">
                    <span>or</span>
                </div>
                <button class="btn btn-google" id="googleLoginBtn">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 .46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8. 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                        <path fill="none" d="M0 0h48v48H0z"/>
                    </svg>
                    Continue with Google
                </button>
            </div>

            <div class="tab-content" id="signupTab">
                <form class="auth-form" id="signupForm">
                    <div class="form-group">
                        <label for="signupName">Rider Name</label>
                        <input type="text" id="signupName" required>
                    </div>
                    <div class="form-group">
                        <label for="signupUID">
                            TrainingPeaks Virtual UID
                            <span class="field-hint">Find this in your TPV profile or past race results</span>
                        </label>
                        <input 
                            type="text" 
                            id="signupUID" 
                            placeholder="e.g., 212354980F57BA1B" 
                            pattern="[0-9A-Fa-f]{15,16}"
                            maxlength="16"
                            required
                            style="text-transform: uppercase; font-family: 'Courier New', monospace;">
                        <small class="field-help">16-character code that links your TPV results to your career</small>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required>
                    </div>
                </form>
                <div class="auth-divider">
                    <span>or</span>
                </div>
                <button class="btn btn-google" id="googleSignupBtn">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                        <path fill="none" d="M0 0h48v48H0z"/>
                    </svg>
                    Sign Up with Google
                </button>
            </div>
        </div>
    </div>


    <!-- UID Modal for Google Sign-In Users -->
    <div class="modal" id="uidModal">
        <div class="modal-overlay" id="uidModalOverlay"></div>
        <div class="modal-content">
            <h2 class="modal-title">Complete Your Profile</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                To link your TrainingPeaks Virtual results, please enter your TPV UID.
            </p>
            <form class="auth-form" id="uidForm">
                <div class="form-group">
                    <label for="googleUID">
                        TrainingPeaks Virtual UID
                        <span class="field-hint">Find this in your TPV profile or past race results</span>
                    </label>
                    <input 
                        type="text" 
                        id="googleUID" 
                        placeholder="e.g., 212354980F57BA1B" 
                        pattern="[0-9A-Fa-f]{15,16}"
                        maxlength="16"
                        required
                        style="text-transform: uppercase; font-family: 'Courier New', monospace;">
                    <small class="field-help">16-character code that links your TPV results to your career</small>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Save UID</button>
            </form>
        </div>
    </div>

    <script src="event-data.js"></script>
    <script src="event-config.js"></script>
    <script src="elevation-profile-generator.js"></script>
    <!-- Narrative System Scripts -->
    <script src="narrative-database.js"></script>
    <script src="story-selector.js"></script>
    <script src="narrative-integration.js"></script>
    <!-- End Narrative System Scripts -->

    <!-- Support/Donate Modal -->
    <div class="modal" id="supportModal">
        <div class="modal-overlay" id="supportModalOverlay"></div>
        <div class="modal-content support-modal-content">
            <button class="modal-close" id="supportModalClose">&times;</button>
            <div class="support-modal-header">
                <span class="support-modal-icon">&#9733;</span>
                <h2 class="modal-title">Support TPV Career Mode</h2>
            </div>
            <div class="support-modal-body">
                <p class="support-description">
                    TPV Career Mode is a passion project built by the community, for the community. Your support helps cover hosting costs and enables new features.
                </p>
                <div class="support-rewards">
                    <h3>Contributor Rewards (&#163;5+)</h3>
                    <ul class="rewards-list">
                        <li><span class="reward-icon">&#9733;</span> Permanent star badge next to your name in rankings</li>
                        <li><span class="reward-icon">&#10024;</span> Exclusive glowing profile effects</li>
                        <li><span class="reward-icon">&#128214;</span> Access to contributor-only story content</li>
                    </ul>
                </div>
                <p class="support-note">
                    After donating on Ko-fi, your contributor status will be activated within 24 hours.
                    Your TPV account ID is automatically included in the donation.
                </p>
                <a href="#" class="btn btn-primary btn-kofi" id="kofiBtn" target="_blank" rel="noopener">
                    &#9749; Support on Ko-fi
                </a>
            </div>
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script type="module" src="event-detail-results.js"></script>
    <script>
        // Get event ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id') || '1';
        const event = getEvent(parseInt(eventId));

        if (!event) {
            window.location.href = 'events.html';
        }

        // Update page content
        document.addEventListener('DOMContentLoaded', async () => {
            // Update title
            document.title = `${event.name} - TPV Career Mode`;

            // Helper function to get stage label
            function getStageLabel(eventId) {
                // Map event IDs to stage numbers
                const eventToStage = {
                    1: 'Stage 1',
                    2: 'Stage 2',
                    3: 'Stage 4',
                    4: 'Stage 5',
                    5: 'Stage 7',
                    13: 'Local Tour Stage 1',
                    14: 'Local Tour Stage 2',
                    15: 'Local Tour Stage 3'
                    // Optional events (6-12) handled separately
                };
                
                // For optional events, just say "Optional Event"
                if (eventId >= 6 && eventId <= 12) {
                    return 'Optional Event';
                }
                
                return eventToStage[eventId] || `Event ${eventId}`;
            }

            const stageLabel = getStageLabel(parseInt(eventId));

            // Update breadcrumb
            document.querySelector('.breadcrumb').innerHTML = `
                <a href="index.html">Home</a> / <a href="events.html">Events</a> / ${event.name}
            `;

            // Update hero section
            document.querySelector('.event-badge').textContent = `${stageLabel} ‚Ä¢ ${event.level}`;
            document.querySelector('.event-hero-title').textContent = event.name;
            document.querySelector('.event-hero-subtitle').textContent = event.subtitle;

            // Update overview cards
            const overviewGrid = document.querySelector('.overview-grid');
            overviewGrid.innerHTML = `
                <div class="overview-card">
                    <div class="overview-icon">üìç</div>
                    <div class="overview-label">Distance</div>
                    <div class="overview-value">${event.distance}</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">‚õ∞Ô∏è</div>
                    <div class="overview-label">Climbing</div>
                    <div class="overview-value">${event.climbing}</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">üè∑Ô∏è</div>
                    <div class="overview-label">Type</div>
                    <div class="overview-value">${event.type}</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">‚≠ê</div>
                    <div class="overview-label">Max Points</div>
                    <div class="overview-value">${event.maxPoints}</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">${event.mandatory ? 'üî¥' : 'üü¢'}</div>
                    <div class="overview-label">Status</div>
                    <div class="overview-value">${event.mandatory ? 'Mandatory' : 'Optional'}</div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">üîÑ</div>
                    <div class="overview-label">Format</div>
                    <div class="overview-value">${event.format}</div>
                </div>
            `;

            // Update story section
            const storyText = document.querySelector('.story-text');
            const descriptionParagraphs = event.description.split('\n\n').map(p => `<p>${p.trim()}</p>`).join('');
            
            let storyHTML = descriptionParagraphs;
            
            if (event.strategy) {
                storyHTML += `
                    <div class="story-callout">
                        <div class="callout-icon">üí°</div>
                        <div class="callout-text">
                            <strong>Race Strategy:</strong> ${event.strategy}
                        </div>
                    </div>
                `;
            }

            // Add stage breakdown for stage races
            if (event.isStageRace && event.stages) {
                storyHTML += `
                    <div class="story-callout story-callout-warning">
                        <div class="callout-icon">‚ö†Ô∏è</div>
                        <div class="callout-text">
                            <strong>Important Stage Race Rules:</strong> Stages must be completed on consecutive days. If you miss a day, you will not be eligible to enter the next stage and your tour will be over. Plan your schedule carefully!
                        </div>
                    </div>
                    
                    <div class="stage-race-breakdown">
                        <h3>Stage Breakdown</h3>
                        ${event.stages.map((stage, i) => `
                            <div class="stage-detail-card">
                                <div class="stage-detail-header">
                                    <span class="stage-detail-number">Stage ${i + 1}</span>
                                    <span class="stage-detail-points">${stage.points} pts</span>
                                </div>
                                <h4>${stage.name}</h4>
                                <div class="stage-detail-stats">
                                    <span>üìç ${stage.distance}</span>
                                    <span>‚õ∞Ô∏è ${stage.climbing}</span>
                                </div>
                                <p>${stage.description}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            storyText.innerHTML = storyHTML;

            // Update route details
            const routeDetailsGrid = document.querySelector('.route-details-grid');
            if (routeDetailsGrid) {
                if (event.isStageRace) {
                    routeDetailsGrid.innerHTML = `
                        <div class="route-detail">
                            <strong>Stage 1:</strong> ${event.routeDetails.stage1}
                        </div>
                        <div class="route-detail">
                            <strong>Stage 2:</strong> ${event.routeDetails.stage2}
                        </div>
                        <div class="route-detail">
                            <strong>Stage 3:</strong> ${event.routeDetails.stage3}
                        </div>
                        <div class="route-detail">
                            <strong>Difficulty:</strong> ${event.routeDetails.difficulty}
                        </div>
                    `;
                } else {
                    const routeKeys = Object.keys(event.routeDetails);
                    routeDetailsGrid.innerHTML = routeKeys.map(key => `
                        <div class="route-detail">
                            <strong>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</strong>
                            ${event.routeDetails[key]}
                        </div>
                    `).join('');
                }
            }


            // Update scoring section
            const scoringGrid = document.querySelector('.scoring-grid');
            if (scoringGrid) {
                // Use custom scoring if available, otherwise calculate
                const points = event.customScoring || calculatePoints(event.maxPoints);
                scoringGrid.innerHTML = points.map(p => `
                    <div class="scoring-card">
                        <div class="scoring-rank">${p.rank}</div>
                        <div class="scoring-points">${p.points} pts</div>
                    </div>
                `).join('');
            }

            // Update course name in breadcrumb callout
            const scoringNote = document.querySelector('.scoring-note');
            if (scoringNote) {
                // Use custom scoring note if available
                const noteText = event.scoringNote || `Points are awarded based on finishing position (top 40 only).`;
                scoringNote.textContent = `${noteText} Course: ${event.course}`;
            }
            
            // Handle stage races vs single events
            if (event.isStageRace && event.stages) {
                // Stage race: show stage switcher and multiple schedule buttons
                let currentStage = 0;
                
                // Show stage switcher
                const stageSwitcher = document.getElementById('stageSwitcher');
                stageSwitcher.style.display = 'flex';
                
                // Map stages to actual courses
                const stageCourses = [
                    'Figure Of Eight',
                    'Loop the Loop', 
                    'A Bit Of Everything'
                ];
                
                // Function to update profile for current stage
                async function updateStageProfile(stageIndex) {
                    currentStage = stageIndex;
                    
                    // Update active button
                    document.querySelectorAll('.stage-btn').forEach((btn, idx) => {
                        btn.classList.toggle('active', idx === stageIndex);
                    });
                    
                    // Update route title
                    document.getElementById('routeTitle').textContent = 
                        `${event.stages[stageIndex].name} Profile`;
                    
                    // Generate profile for this stage
                    const courseName = stageCourses[stageIndex];
                    console.log(`Generating profile for ${courseName}`);
                    
                    if (window.elevationProfileGen) {
                        await window.elevationProfileGen.generateProfile(
                            'elevationProfileCanvas',
                            courseName,
                            1 // Stages are always 1 lap
                        );
                    }
                }
                
                // Set up stage switcher buttons
                document.querySelectorAll('.stage-btn').forEach((btn, idx) => {
                    btn.addEventListener('click', () => updateStageProfile(idx));
                });
                
                // Populate CTA with stage buttons
                const ctaBox = document.getElementById('ctaBox');
                ctaBox.innerHTML = `
                    <h2>Ready to Race?</h2>
                    <p class="cta-warning">
                        <strong>‚ö†Ô∏è Important:</strong> Stages must be completed on <strong>consecutive days</strong>. 
                        Missing a day disqualifies you from continuing the tour.
                    </p>
                    <div class="stage-cta-grid">
                        ${event.stages.map((stage, idx) => `
                            <div class="stage-cta-card">
                                <div class="stage-number-badge">Day ${idx + 1}</div>
                                <h3>${stage.name}</h3>
                                <div class="stage-cta-details">
                                    <span>üìç ${stage.distance}</span>
                                    <span>‚õ∞Ô∏è ${stage.climbing}</span>
                                    <span>‚≠ê ${stage.points} pts</span>
                                </div>
                                <button class="btn btn-primary" onclick="alert('Schedule Stage ${idx + 1} on TPV')">
                                    Schedule Stage ${idx + 1}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="cta-buttons" style="margin-top: 2rem;">
                        <button class="btn btn-secondary btn-large" onclick="location.href='events.html'">Back to Events</button>
                    </div>
                `;
                
                // Load Stage 1 profile by default
                await updateStageProfile(0);
                
            } else {
                // Single event: standard flow
                // Hide stage switcher
                document.getElementById('stageSwitcher').style.display = 'none';
                
                // Populate standard CTA
                const ctaBox = document.getElementById('ctaBox');
                ctaBox.innerHTML = `
                    <h2>Ready to Race?</h2>
                    <p>Schedule this event on TrainingPeaks Virtual and complete it to progress in your career.</p>
                    <div class="cta-buttons">
                        <button class="btn btn-primary btn-large" id="scheduleButton">Schedule Event</button>
                        <button class="btn btn-secondary btn-large" onclick="location.href='events.html'">Back to Events</button>
                    </div>
                `;
                
                // Generate elevation profile
                const laps = parseInt(event.format.match(/(\d+)\s*lap/i)?.[1] || 1);
                console.log(`Generating elevation profile for ${event.course} (${laps} lap${laps > 1 ? 's' : ''})`);
                
                if (window.elevationProfileGen) {
                    await window.elevationProfileGen.generateProfile(
                        'elevationProfileCanvas',
                        event.course,
                        laps
                    );
                } else {
                    console.error('Elevation profile generator not loaded');
                }
            }

            // Clear loading state from all sections after event data is loaded
            document.querySelectorAll('.section-loading').forEach(section => {
                section.classList.remove('section-loading');
                section.classList.add('section-loaded');
            });
        });
    </script>
    <script src="awards-config.js"></script>
    <script src="notification-queue.js"></script>
    <script src="achievement-notifications.js"></script>
    <script src="unlock-config.js"></script>
    <script src="currency-config.js"></script>
    <script src="unlock-image-loader.js"></script>
    <script src="unlock-card-component.js"></script>
    <script type="module" src="cadence-credits.js"></script>
    <script type="module">
        import { initializePersonalityAwardDefinitions } from './personality-awards-notifications.js';
        // Initialize personality award definitions when page loads
        initializePersonalityAwardDefinitions();
    </script>
</body>
</html>
