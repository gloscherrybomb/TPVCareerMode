<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - TPV Career Mode</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="tpv-team-car.png">
    <link rel="apple-touch-icon" href="tpv-team-car.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="settings.css">
    <!-- Apply readable font preference early to prevent FOUC -->
    <script>
        if (localStorage.getItem('tpv_readable_font') === 'true') {
            document.documentElement.classList.add('readable-font');
        }
    </script>
</head>
<body>
    <div id="navbar-placeholder"></div>

    <!-- Main Content -->
    <main class="profile-page">
        <div class="container">
            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>Loading settings...</p>
            </div>

            <!-- Login Prompt -->
            <div id="loginPrompt" class="login-prompt" style="display: none;">
                <div class="login-prompt-icon"><img src="icons/svg/ui/locked.svg" alt="Locked"></div>
                <h2>Please Log In</h2>
                <p>You need to be logged in to access settings.</p>
                <button class="btn btn-primary" onclick="document.getElementById('loginBtn').click()">
                    Log In
                </button>
            </div>

            <!-- Settings Content -->
            <div id="settingsContent" style="display: none;">
                <!-- Page Header -->
                <div class="settings-header">
                    <a href="profile.html" class="btn-back">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back to Profile
                    </a>
                    <h1 class="page-title">Settings</h1>
                </div>

                <!-- Profile Settings Section -->
                <div class="settings-section">
                    <h2 class="section-title">Profile Settings</h2>
                    <div class="settings-card">
                        <!-- Display Name -->
                        <div class="form-group">
                            <label for="settingsName">Display Name</label>
                            <div class="input-with-button">
                                <input type="text" id="settingsName" placeholder="Enter your display name">
                                <button class="btn btn-secondary" id="saveNameBtn">Save</button>
                            </div>
                        </div>

                        <!-- Profile Photo -->
                        <div class="form-group">
                            <label>Profile Photo</label>
                            <div class="photo-upload-area">
                                <div class="photo-preview-wrapper">
                                    <img id="photoPreview" src="" alt="Profile Photo" class="photo-preview">
                                    <div class="photo-placeholder" id="photoPlaceholder">
                                        <span id="photoInitials"></span>
                                    </div>
                                </div>
                                <div class="photo-upload-controls">
                                    <button class="btn btn-secondary" id="uploadPhotoBtn">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                            <circle cx="12" cy="13" r="4"></circle>
                                        </svg>
                                        Upload Photo
                                    </button>
                                    <input type="file" id="photoUpload" accept="image/*" style="display: none;">
                                    <p class="form-help">Recommended: Square image, at least 200x200px</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Discord Notifications Section -->
                <div class="settings-section">
                    <h2 class="section-title">
                        <img src="assets/Discord-Symbol-Blurple.png" alt="Discord" class="section-icon">
                        Discord Notifications
                    </h2>
                    <div class="settings-card">
                        <!-- Enable Toggle -->
                        <div class="form-group-toggle">
                            <label class="toggle-label">
                                <input type="checkbox" id="discordEnabled">
                                <span class="toggle-switch"></span>
                                <span class="toggle-text">Enable Discord DM notifications when race results are processed</span>
                            </label>
                        </div>

                        <!-- Discord Link Section -->
                        <div id="discordLinkSection" class="discord-link-section" style="display: none;">
                            <!-- Unlinked State -->
                            <div id="discordUnlinkedState" class="discord-state">
                                <div class="link-instructions">
                                    <h3>Link Your Discord Account</h3>
                                    <p>To receive race notifications as Discord DMs, link your account using our bot:</p>
                                    <ol>
                                        <li>
                                            <a href="https://discord.com/oauth2/authorize?client_id=1458044738820116633&permissions=0&scope=bot%20applications.commands"
                                               target="_blank"
                                               class="btn-discord"
                                               id="addBotBtn">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
                                                </svg>
                                                Add Bot to Your Discord
                                            </a>
                                            <span class="step-note">Add the bot to any server you're in</span>
                                        </li>
                                        <li>
                                            Copy your TPV UID:
                                            <code id="userUidDisplay">Loading...</code>
                                            <button class="btn-copy" id="copyUidBtn" title="Copy UID">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                </svg>
                                            </button>
                                        </li>
                                        <li>In that server, type <code>/link</code> and paste your UID
                                            <span class="step-note">Commands work in any channel - only you see the response</span>
                                        </li>
                                    </ol>
                                </div>
                                <p class="discord-hint">Don't have Discord? <a href="https://discord.com/download" target="_blank">Download it here</a> - it's free!</p>
                            </div>

                            <!-- Linked State -->
                            <div id="discordLinkedState" class="discord-state" style="display: none;">
                                <div class="link-status linked">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                    </svg>
                                    <div>
                                        <strong>Discord Linked</strong>
                                        <p id="discordLinkedInfo">You'll receive DM notifications for race results</p>
                                    </div>
                                </div>
                                <p class="unlink-hint">
                                    Use <code>/test</code> to send a test notification &bull; <code>/unlink</code> to disconnect
                                </p>
                            </div>
                        </div>

                        <div id="discordStatus" class="discord-status" style="display: none;"></div>
                    </div>
                </div>

                <!-- Display Settings Section -->
                <div class="settings-section">
                    <h2 class="section-title">Display Settings</h2>
                    <div class="settings-card">
                        <div class="form-group-toggle">
                            <label class="toggle-label">
                                <input type="checkbox" id="readableFontToggle">
                                <span class="toggle-switch"></span>
                                <span class="toggle-text">Use readable font for statistics</span>
                            </label>
                            <p class="form-help">Switches the stylized Orbitron font to Exo 2 for better readability on the Palmares page</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-overlay" id="loginModalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="loginModalClose">&times;</button>
            <div class="modal-header">
                <h2>Welcome to TPV Career Mode</h2>
                <p class="modal-subtitle">Log in or create an account to get started</p>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Login</button>
                    <button class="auth-tab" data-tab="signup">Sign Up</button>
                </div>

                <!-- Login Form -->
                <div class="auth-form active" id="loginForm">
                    <form id="emailLoginForm">
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">Log In</button>
                    </form>
                    <div class="divider">
                        <span>OR</span>
                    </div>
                    <button class="btn btn-google" id="googleLoginBtn">
                        <svg width="18" height="18" viewBox="0 0 18 18">
                            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                            <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
                            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                        </svg>
                        Continue with Google
                    </button>
                </div>

                <!-- Signup Form -->
                <div class="auth-form" id="signupForm">
                    <form id="emailSignupForm">
                        <div class="form-group">
                            <label for="signupName">Display Name</label>
                            <input type="text" id="signupName" required>
                        </div>
                        <div class="form-group">
                            <label for="signupUID">
                                TrainingPeaks Virtual UID
                                <span class="form-help">16-character hex code from TPV</span>
                            </label>
                            <input type="text" id="signupUID" maxlength="16" pattern="[0-9A-Fa-f]{15,16}" required style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="signupEmail">Email</label>
                            <input type="email" id="signupEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="signupPassword">Password</label>
                            <input type="password" id="signupPassword" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">Create Account</button>
                    </form>
                    <div class="divider">
                        <span>OR</span>
                    </div>
                    <button class="btn btn-google" id="googleSignupBtn">
                        <svg width="18" height="18" viewBox="0 0 18 18">
                            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                            <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
                            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                        </svg>
                        Sign up with Google
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- UID Modal for Google Users -->
    <div class="modal" id="uidModal">
        <div class="modal-overlay" id="uidModalOverlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Enter Your TPV UID</h2>
                <p class="modal-subtitle">We need your TrainingPeaks Virtual UID to track your race results</p>
            </div>
            <div class="modal-body">
                <form id="uidForm">
                    <div class="form-group">
                        <label for="googleUID">
                            TrainingPeaks Virtual UID
                            <span class="form-help">16-character hex code from TPV (e.g., A1B2C3D4E5F67890)</span>
                        </label>
                        <input type="text" id="googleUID" maxlength="16" pattern="[0-9A-Fa-f]{15,16}" required style="text-transform: uppercase;" placeholder="Enter your UID">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save UID</button>
                </form>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script type="module" src="app.js"></script>
    <script type="module" src="settings.js"></script>
</body>
</html>
