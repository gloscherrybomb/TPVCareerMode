<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palmares - TPV Career Mode</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="tpv-team-car.png">
    <link rel="apple-touch-icon" href="tpv-team-car.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;700;800;900&family=Bebas+Neue&family=Barlow:wght@400;500;600;700&family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="palmares.css">
    <link rel="stylesheet" href="season-switcher.css">
    <link rel="stylesheet" href="icons/icons.css">
    <script src="icons/icons.js"></script>
    <!-- Apply readable font preference early to prevent FOUC -->
    <script>
        if (localStorage.getItem('tpv_readable_font') === 'true') {
            document.documentElement.classList.add('readable-font');
        }
    </script>
</head>
<body>
    <div id="navbar-placeholder"></div>

    <!-- Main Content -->
    <main class="palmares-page">
        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
            <p>Loading palmares...</p>
        </div>

        <!-- Login Prompt -->
        <div id="loginPrompt" class="login-prompt" style="display: none;">
            <div class="login-prompt-icon">üîí</div>
            <h2>Please Log In</h2>
            <p>You need to be logged in to view your palmares.</p>
            <button class="btn btn-primary" onclick="document.getElementById('loginBtn').click()">
                Log In
            </button>
        </div>

        <!-- Palmares Content -->
        <div id="palmaresContent" class="container" style="display: none;">
            <!-- Hero Header -->
            <div class="palmares-hero">
                <div class="hero-bg-pattern"></div>
                <div class="hero-content">
                    <a href="profile.html" class="btn-back">
                        <span class="back-arrow">‚Üê</span> Back to Profile
                    </a>
                    <div class="hero-main">
                        <div class="rider-showcase">
                            <div class="rider-photo-wrapper">
                                <img id="riderPhoto" src="" alt="Rider Photo" class="rider-photo-large">
                                <div class="photo-glow"></div>
                            </div>
                            <div class="rider-identity">
                                <h1 class="rider-name" id="riderName">‚Äî</h1>
                                <div class="rider-meta">
                                    <span id="riderTeam" class="team-name">‚Äî</span>
                                    <span class="meta-divider">‚Ä¢</span>
                                    <span class="career-label">Season <span id="currentSeason">1</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="arr-showcase">
                            <div class="arr-badge">
                                <span class="arr-label">ARR</span>
                                <span class="arr-value" id="riderARR">‚Äî</span>
                            </div>
                            <div class="career-events">
                                <span id="totalEvents">0</span> Career Events
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search & Filter Controls -->
            <div class="palmares-controls">
                <input type="text" id="searchFilter" placeholder="Search events, opponents..." class="control-search">
                <select id="filterType" class="control-select">
                    <option value="all">All Events</option>
                    <option value="wins">Wins Only</option>
                    <option value="podiums">Podiums</option>
                    <option value="top10">Top 10</option>
                    <option value="dnf">DNF</option>
                </select>
                <select id="filterCategory" class="control-select">
                    <option value="all">All Types</option>
                    <option value="criterium">Criteriums</option>
                    <option value="time trial">Time Trials</option>
                    <option value="road race">Road Races</option>
                    <option value="track">Track</option>
                    <option value="climbing">Climbing</option>
                </select>
                <div class="result-count">
                    Showing <span id="resultCount">0</span> of <span id="totalResults">0</span>
                </div>
            </div>

            <!-- Key Statistics Summary -->
            <div class="key-stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Races</span>
                    <span class="stat-value" id="statRaces">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Wins</span>
                    <span class="stat-value" id="statWins">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Podiums</span>
                    <span class="stat-value" id="statPodiums">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Top 10</span>
                    <span class="stat-value" id="statTop10">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">DNF</span>
                    <span class="stat-value" id="statDNF">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Avg</span>
                    <span class="stat-value" id="statAvg">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Points</span>
                    <span class="stat-value" id="statPoints">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Cadence Coins (Career)</span>
                    <span class="stat-value" id="statCadenceCoins">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">ARR</span>
                    <span class="stat-value" id="statARR">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">High 5s</span>
                    <span class="stat-value" id="statHighFives">0</span>
                </div>
            </div>

            <!-- Trophy Case - Key Achievements -->
            <div class="trophy-case">
                <h2 class="trophy-case-title">Career Highlights</h2>
                <div class="trophy-grid">
                    <div class="trophy-card" id="achievementBestPred">
                        <div class="trophy-icon-wrap" data-icon="bullseye"></div>
                        <div class="trophy-content">
                            <span class="trophy-label">Best vs Expected</span>
                            <span class="trophy-value">‚Äî</span>
                            <span class="trophy-detail">positions</span>
                        </div>
                    </div>
                    <div class="trophy-card featured" id="achievementBiggestWin">
                        <div class="trophy-icon-wrap" data-icon="trophy"></div>
                        <div class="trophy-content">
                            <span class="trophy-label">Biggest Win</span>
                            <span class="trophy-value">‚Äî</span>
                            <span class="trophy-detail"></span>
                        </div>
                    </div>
                    <div class="trophy-card" id="achievementHighestARR">
                        <div class="trophy-icon-wrap" data-icon="specialist"></div>
                        <div class="trophy-content">
                            <span class="trophy-label">Peak ARR</span>
                            <span class="trophy-value">‚Äî</span>
                            <span class="trophy-detail"></span>
                        </div>
                    </div>
                    <div class="trophy-card" id="achievementBiggestGiant">
                        <div class="trophy-icon-wrap" data-icon="giantKiller"></div>
                        <div class="trophy-content">
                            <span class="trophy-label">Biggest Giant Beaten</span>
                            <span class="trophy-value">‚Äî</span>
                            <span class="trophy-detail">ARR</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Season Stats Section (for completed seasons) -->
            <div id="seasonStatsSection" class="palmares-section" style="display: none;">
                <h2 class="section-heading">Completed Season Stats</h2>
                <div id="seasonStatsContainer" class="season-stats-grid">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- Main Results Table -->
            <div class="palmares-section">
                <h2 class="section-heading">Complete Results History</h2>
                <div class="results-table-wrapper">
                    <table class="palmares-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="date">Date <span class="sort-indicator"></span></th>
                                <th class="sortable" data-sort="event">Event <span class="sort-indicator"></span></th>
                                <th class="sortable align-center" data-sort="season">Season <span class="sort-indicator"></span></th>
                                <th class="sortable align-center" data-sort="stage">Stage <span class="sort-indicator"></span></th>
                                <th class="sortable align-center" data-sort="position">Pos <span class="sort-indicator"></span></th>
                                <th class="sortable align-center" data-sort="vspred">vs Pred <span class="sort-indicator"></span></th>
                                <th class="sortable align-right" data-sort="arr">ARR <span class="sort-indicator"></span></th>
                                <th class="sortable align-right" data-sort="points">Points <span class="sort-indicator"></span></th>
                                <th class="align-center">Awards</th>
                                <th class="sortable align-right" data-sort="cc">CC <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div id="paginationControls" class="pagination-controls" style="display: none;">
                    <button id="loadMoreBtn" class="btn btn-secondary btn-load-more">
                        Load More Results
                    </button>
                    <span id="paginationStatus" class="pagination-status"></span>
                </div>
            </div>

            <!-- Detailed Statistics Sections -->
            <div class="stats-grid">
                <!-- Career Totals -->
                <div class="palmares-section stat-section stat-section-totals">
                    <div class="section-header">
                        <div class="section-icon" data-icon="stats"></div>
                        <h2 class="section-heading">Career Totals</h2>
                    </div>
                    <div class="stat-list">
                        <div class="stat-row">
                            <span class="stat-row-label">Total Distance:</span>
                            <span class="stat-row-value" id="totalDistance">0 km</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total Climbing:</span>
                            <span class="stat-row-value" id="totalClimbing">0 m</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total Race Time:</span>
                            <span class="stat-row-value" id="totalRaceTime">0h 0m</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Events Completed:</span>
                            <span class="stat-row-value" id="eventsCompleted">0 / 0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Completion Rate:</span>
                            <span class="stat-row-value" id="completionRate">100%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total Career CC:</span>
                            <span class="stat-row-value" id="totalCareerCC">0 CC</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">High 5s Received:</span>
                            <span class="stat-row-value" id="totalHighFives">0</span>
                        </div>
                    </div>
                </div>

                <!-- Performance Breakdown -->
                <div class="palmares-section stat-section stat-section-performance">
                    <div class="section-header">
                        <div class="section-icon" data-icon="trophy"></div>
                        <h2 class="section-heading">Performance</h2>
                    </div>
                    <div class="stat-list">
                        <div class="stat-row">
                            <span class="stat-row-label">Wins:</span>
                            <span class="stat-row-value" id="perfWins">0 (0%)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Podiums:</span>
                            <span class="stat-row-value" id="perfPodiums">0 (0%)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Top 10 Finishes:</span>
                            <span class="stat-row-value" id="perfTop10">0 (0%)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Average Finish:</span>
                            <span class="stat-row-value" id="perfAvgFinish">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Best Finish:</span>
                            <span class="stat-row-value" id="perfBestFinish">‚Äî</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Worst Finish:</span>
                            <span class="stat-row-value" id="perfWorstFinish">‚Äî</span>
                        </div>
                    </div>
                    <div class="stat-subsection">
                        <h3 class="subsection-heading">Consistency</h3>
                        <div class="stat-list">
                            <div class="stat-row">
                                <span class="stat-row-label">Longest Top-10 Streak:</span>
                                <span class="stat-row-value" id="longestTop10Streak">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-row-label">Longest Podium Streak:</span>
                                <span class="stat-row-value" id="longestPodiumStreak">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-row-label">Longest No-DNF Streak:</span>
                                <span class="stat-row-value" id="longestNoDNFStreak">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Competition Analysis -->
                <div class="palmares-section stat-section stat-section-competition">
                    <div class="section-header">
                        <div class="section-icon" data-icon="giantKiller"></div>
                        <h2 class="section-heading">Competition</h2>
                    </div>
                    <div class="stat-list">
                        <div class="stat-row">
                            <span class="stat-row-label">Avg Opponent ARR:</span>
                            <span class="stat-row-value" id="avgOpponentARR">‚Äî</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Win Rate vs Stronger:</span>
                            <span class="stat-row-value" id="winRateVsStronger">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Win Rate vs Weaker:</span>
                            <span class="stat-row-value" id="winRateVsWeaker">0%</span>
                        </div>
                    </div>
                    <div class="stat-subsection">
                        <h3 class="subsection-heading">Toughest Victory</h3>
                        <div class="stat-list" id="toughestVictory">
                            <div class="stat-row-text">No wins yet</div>
                        </div>
                    </div>
                </div>

                <!-- Specialty & Versatility -->
                <div class="palmares-section stat-section stat-section-specialty">
                    <div class="section-header">
                        <div class="section-icon" data-icon="allRounder"></div>
                        <h2 class="section-heading">Specialty</h2>
                    </div>
                    <div class="stat-list">
                        <div class="stat-row">
                            <span class="stat-row-label">Best Race Type:</span>
                            <span class="stat-row-value" id="bestRaceType">‚Äî</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Versatility Score:</span>
                            <span class="stat-row-value" id="versatilityScore">‚Äî / 10</span>
                        </div>
                    </div>
                    <div class="stat-subsection">
                        <h3 class="subsection-heading">Event Type Distribution</h3>
                        <div class="stat-list" id="eventTypeDistribution">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Power Records Section -->
            <div class="palmares-section stat-section" id="powerRecordsSection" style="display: none;">
                <h2 class="section-heading">Power Records</h2>
                <div class="stat-list" id="powerRecordsList">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- Awards Section -->
            <div class="palmares-section">
                <h2 class="section-heading">Awards & Achievements</h2>
                <div class="awards-table-wrapper">
                    <table class="awards-table">
                        <thead>
                            <tr>
                                <th>Award</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody id="awardsTableBody">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Personality Evolution -->
            <div class="palmares-section" id="personalitySection" style="display: none;">
                <h2 class="section-heading">Personality Development</h2>
                <div class="personality-chart-container">
                    <div class="current-persona" id="currentPersona">
                        <!-- Populated via JS -->
                    </div>
                    <canvas id="personalityChart" width="1200" height="400"></canvas>
                </div>
            </div>

            <!-- Head-to-Head Records -->
            <div class="palmares-section" id="rivalsSection" style="display: none;">
                <h2 class="section-heading">Top 10 Rivals</h2>
                <div class="rivals-table-wrapper">
                    <table class="rivals-table">
                        <thead>
                            <tr>
                                <th>Opponent</th>
                                <th>Races</th>
                                <th>W-L</th>
                                <th>Win %</th>
                                <th>Their ARR</th>
                            </tr>
                        </thead>
                        <tbody id="rivalsTableBody">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <div class="modal-header">
                <div class="modal-tabs">
                    <button class="modal-tab active" data-tab="login">Login</button>
                    <button class="modal-tab" data-tab="signup">Sign Up</button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Login Tab -->
                <div class="tab-content active" id="loginTab">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="rememberMe" checked>
                            <label for="rememberMe">Remember me</label>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">Login</button>
                    </form>
                    <div class="divider">
                        <span>OR</span>
                    </div>
                    <button class="btn btn-google" id="googleLoginBtn">
                        <svg width="18" height="18" viewBox="0 0 18 18">
                            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                            <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
                            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                        </svg>
                        Sign in with Google
                    </button>
                </div>

                <!-- Sign Up Tab -->
                <div class="tab-content" id="signupTab">
                    <form id="signupForm">
                        <div class="form-group">
                            <label for="signupName">Full Name</label>
                            <input type="text" id="signupName" required>
                        </div>
                        <div class="form-group">
                            <label for="signupUID">
                                TrainingPeaks Virtual UID
                                <span class="form-help">16-character hex code from TPV</span>
                            </label>
                            <input type="text" id="signupUID" maxlength="16" pattern="[0-9A-Fa-f]{15,16}" required style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="signupEmail">Email</label>
                            <input type="email" id="signupEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="signupPassword">Password</label>
                            <input type="password" id="signupPassword" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">Create Account</button>
                    </form>
                    <div class="divider">
                        <span>OR</span>
                    </div>
                    <button class="btn btn-google" id="googleSignupBtn">
                        <svg width="18" height="18" viewBox="0 0 18 18">
                            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                            <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
                            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                        </svg>
                        Sign up with Google
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- UID Modal for Google Users -->
    <div class="modal" id="uidModal">
        <div class="modal-overlay" id="uidModalOverlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Enter Your TPV UID</h2>
                <p class="modal-subtitle">We need your TrainingPeaks Virtual UID to track your race results</p>
            </div>
            <div class="modal-body">
                <form id="uidForm">
                    <div class="form-group">
                        <label for="googleUID">
                            TrainingPeaks Virtual UID
                            <span class="form-help">16-character hex code from TPV (e.g., A1B2C3D4E5F67890)</span>
                        </label>
                        <input type="text" id="googleUID" maxlength="16" pattern="[0-9A-Fa-f]{15,16}" required style="text-transform: uppercase;" placeholder="Enter your UID">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save UID</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Support/Donate Modal -->
    <div class="modal" id="supportModal">
        <div class="modal-overlay" id="supportModalOverlay"></div>
        <div class="modal-content support-modal-content">
            <button class="modal-close" id="supportModalClose">&times;</button>
            <div class="support-modal-header">
                <span class="support-modal-icon"><img src="icons/svg/awards/glowing-star.svg" alt="Support"></span>
                <h2 class="modal-title">Support TPV Career Mode</h2>
            </div>
            <div class="support-modal-body">
                <p class="support-description">
                    TPV Career Mode is a passion project built by the community, for the community. Your support helps cover hosting costs and enables new features.
                </p>
                <div class="support-rewards">
                    <h3>Contributor Rewards (&#163;5+)</h3>
                    <ul class="rewards-list">
                        <li><span class="reward-icon"><img src="icons/svg/awards/glowing-star.svg" alt="Star"></span> Permanent star badge next to your name in rankings</li>
                        <li><span class="reward-icon"><img src="icons/svg/awards/sparkles.svg" alt="Sparkles"></span> Exclusive glowing profile effects</li>
                        <li><span class="reward-icon"><img src="icons/svg/ui/book.svg" alt="Book"></span> Access to contributor-only story content</li>
                    </ul>
                </div>
                <p class="support-note">
                    After donating on Ko-fi, your contributor status will be activated within 24 hours.
                    Your TPV account ID is automatically included in the donation.
                </p>
                <a href="#" class="btn btn-primary btn-kofi" id="kofiBtn" target="_blank" rel="noopener">
                    <img src="icons/svg/ui/coffee.svg" alt="Coffee" class="kofi-icon"> Support on Ko-fi
                </a>
            </div>
        </div>
    </div>

    <!-- Include Firebase and authentication -->
    <script src="season-config.js"></script>
    <script src="season-data-helpers.js"></script>
    <script type="module" src="app.js"></script>
    <script type="module" src="palmares.js"></script>
    <script type="module" src="analytics.js"></script>
</body>
</html>
